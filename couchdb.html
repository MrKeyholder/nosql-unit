<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;1.&nbsp;CouchDB Engine</title><link rel="stylesheet" type="text/css" href="stylesheet.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="chapter" title="Chapter&nbsp;1.&nbsp;CouchDB Engine"><div class="titlepage"><div><div><h2 class="title"><a name="couchdb"></a>Chapter&nbsp;1.&nbsp;CouchDB Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d172e4">CouchDB</a></span></dt><dd><dl><dt><span class="section"><a href="#d172e60">Maven Setup</a></span></dt><dt><span class="section"><a href="#d172e76">Dataset Format</a></span></dt><dt><span class="section"><a href="#d172e99">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="CouchDB"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d172e4"></a>CouchDB</h2></div></div></div><p>
			<span class="application">CouchDB</span>
			is a
			<span class="emphasis"><em>NoSQL</em></span>
			database that stores structured data as
			<span class="emphasis"><em>JSON-like</em></span>
			documents with dynamic schemas.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>CouchDB</em></span>
			by using next classes:
		</p><p>
		</p><table border="1" id="d172e28"><caption>Table&nbsp;1.1.&nbsp;Lifecycle Management Rules</caption><tr>
				<td>Managed</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.couchdb.ManagedCouchDb
					</code>
				</td>
			</tr></table><p>
		</p><p>
		</p><table border="1" id="d172e45"><caption>Table&nbsp;1.2.&nbsp;Manager Rule</caption><tr>
				<td>NoSQLUnit Management</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.couchdb.CouchDbRule
					</code>
				</td>
			</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d172e60"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">CouchDB</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.couchdb_nosqlunit_dep"></a><p class="title"><b>Example&nbsp;1.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-couchdb<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d172e76"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>CouchDB</em></span>
				module
				is
				<span class="emphasis"><em>json</em></span>
				.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.couchdb_dataset" title="Example&nbsp;1.2.&nbsp;Example of CouchDB Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.couchdb_dataset"></a><p class="title"><b>Example&nbsp;1.2.&nbsp;Example of CouchDB Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"data":
			[
				{"attribute1":"value1", "atribute2":"value2", ...},
				{...}
			]
}</pre></div></div><br class="example-break"><p>Notice that if attributes value are integers, double quotes are
				not required.
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d172e99"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d172e102"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you
					will require an
					<span class="bold"><strong>managed</strong></span>
					approach or
					<span class="bold"><strong>remote</strong></span>
					approach.
				</p><p>
				There is no <span class="emphasis"><em>CouchDB</em></span> inmemory instance, so only managed or remote lifecycle can be used.
				</p><p>
					To configure the
					<span class="bold"><strong>managed</strong></span>
					way,
					you should use
					<code class="classname">ManagedCouchDb</code>
					rule and may
					require some <a class="link" href="#program.couchdb_managed_conf" title="Example&nbsp;1.3.&nbsp;Managed CouchDB">configuration</a> parameters.
				</p><div class="example"><a name="program.couchdb_managed_conf"></a><p class="title"><b>Example&nbsp;1.3.&nbsp;Managed CouchDB</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.couchdb.ManagedCouchDb.ManagedCouchDbRuleBuilder.newManagedCouchDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedCouchDb managedCouchDb = newManagedCouchDbRule().couchDbPath(<strong class="hl-string"><em style="color:red">"/usr/local"</em></strong>).build(); </pre></div></div><br class="example-break"><p>
					By default managed
					<span class="emphasis"><em>CouchDB</em></span>
					rule uses next
					default values:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>CouchDB</em></span>
							installation directory is
							retrieved from
							<code class="varname">COUCHDB_HOME</code>
							system environment
							variable.
						</p></li><li class="listitem"><p>
							Target path, that is the directory where
							<span class="emphasis"><em>CouchDB</em></span>
							server is started, is
							<code class="constant">target/couchdb-temp</code>
							.
						</p></li><li class="listitem"><p>
							Port where <span class="emphasis"><em>CouchDB</em></span> will be started. Note that this parameter is used only as information, if you change port from configuration file you should change this parameter too.
							By default<span class="emphasis"><em>CouchDB</em></span>
							server is started at
							<code class="constant">5984</code>
							.
						</p></li></ul></div><p>
					Configuring
					<span class="bold"><strong>remote</strong></span>
					approach
					does not require any special rule because you (or System like
					<span class="application">Maven</span>
					) is the responsible of starting and
					stopping the server. This mode is used in deployment tests where you
					are testing your application on real environment.
				</p></div><div class="section" title="Configuring CouchDB Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d172e178"></a>Configuring CouchDB Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="emphasis"><em>
						<span class="bold"><strong>CouchDB</strong></span>
					</em></span>
					rule in charge of
					maintaining
					<span class="emphasis"><em>CouchDB</em></span>
					database into known state by
					inserting and deleting defined datasets. You must register
					<code class="classname">CouchDbRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule
					class, which requires a configuration parameter with information like
					host, port or database name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects.
				</p><table border="1" id="d172e200"><caption>Table&nbsp;1.3.&nbsp;Default Managed Configuration Values</caption><tr>
						<td>URI</td>

						<td>http://localhost5984</td>
					</tr><tr>
						<td>Authentication</td>

						<td>No authentication parameters.</td>
					</tr><tr>
						<td>Enable SSL</td>

						<td>false.</td>
					</tr><tr>
						<td>Relaxed SSL Settings</td>

						<td>false.</td>
					</tr><tr>
						<td>Caching</td>

						<td>True.</td>
					</tr></table><div class="example"><a name="program.couchdb_managed_connection_parameters"></a><p class="title"><b>Example&nbsp;1.4.&nbsp;CouchDBRule with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.couchdb.CouchDbRule.CouchDbRuleBuilder.newCouchDbRule;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> CouchDbRule couchDbRule = newCouchDbRule().defaultManagedMongoDb(<strong class="hl-string"><em style="color:red">"books"</em></strong>);</pre></div></div><br class="example-break"></div><div class="section" title="Complete Example"><div class="titlepage"><div><div><h4 class="title"><a name="d172e248"></a>Complete Example</h4></div></div></div><p>
					Consider a library application, which apart from multiple
					operations, it allow us to add new books to system. Our
					<a class="link" href="#example.couchdb_book_model" title="Example&nbsp;1.5.&nbsp;Book POJO">model</a>
					is as simple as:
				</p><div class="example"><a name="example.couchdb_book_model"></a><p class="title"><b>Example&nbsp;1.5.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> Book {

	<strong class="hl-keyword">private</strong> String title;

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">int</strong> numberOfPages;

	<strong class="hl-keyword">public</strong> Book(String title, <strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">super</strong>();
		<strong class="hl-keyword">this</strong>.title = title;
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setTitle(String title) {
		<strong class="hl-keyword">this</strong>.title = title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setNumberOfPages(<strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}


	<strong class="hl-keyword">public</strong> String getTitle() {
		<strong class="hl-keyword">return</strong> title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">int</strong> getNumberOfPages() {
		<strong class="hl-keyword">return</strong> numberOfPages;
	}
}</pre></div></div><br class="example-break"><p>
					Next business
					<a class="link" href="#example.couchdb_book_manager" title="Example&nbsp;1.6.&nbsp;Book POJO">class</a>
					is the responsible of managing access to
					<span class="emphasis"><em>CouchDB</em></span>
					server:
				</p><div class="example"><a name="example.couchdb_book_manager"></a><p class="title"><b>Example&nbsp;1.6.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">private</strong> CouchDbConnector connector;
	
	<strong class="hl-keyword">public</strong> BookManager(CouchDbConnector connector)  {
		<strong class="hl-keyword">this</strong>.connector = connector;
	}
	
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> create(Book book) {
		connector.create(MapBookConverter.toMap(book));
	}

	<strong class="hl-keyword">public</strong> Book findBookById(String id) {
		Map&lt;String, Object&gt; map = connector.get(Map.<strong class="hl-keyword">class</strong>, id);
		<strong class="hl-keyword">return</strong> MapBookConverter.toBook(map);
	}</pre></div></div><br class="example-break"><p>
					And now it is time for testing. In next
					<a class="link" href="#example.couchdb_test_find_book" title="Example&nbsp;1.7.&nbsp;Test with Managed Connection">test</a>
					we are going to
					validate that a book is found into database.
				</p><div class="example"><a name="example.couchdb_test_find_book"></a><p class="title"><b>Example&nbsp;1.7.&nbsp;Test with Managed Connection</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenYouFindBooksById {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedCouchDb managedCouchDb = newManagedCouchDbRule().couchDbPath(<strong class="hl-string"><em style="color:red">"/usr/local"</em></strong>).build(); 
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> CouchDbRule couchDbRule = newCouchDbRule().defaultManagedMongoDb(<strong class="hl-string"><em style="color:red">"books"</em></strong>);
	
	<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
	<strong class="hl-keyword">private</strong> CouchDbConnector couchDbConnector;
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="books.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> identified_book_should_be_returned() {
		
		BookManager bookManager = <strong class="hl-keyword">new</strong> BookManager(couchDbConnector);
		Book book = bookManager.findBookById(<strong class="hl-string"><em style="color:red">"1"</em></strong>);
		
		assertThat(book.getTitle(), is(<strong class="hl-string"><em style="color:red">"The Hobbit"</em></strong>));
		assertThat(book.getNumberOfPages(), is(<span class="hl-number">293</span>));
		
	}
	
}</pre></div></div><br class="example-break"><div class="example"><a name="example.couchdb_dataset_book"></a><p class="title"><b>Example&nbsp;1.8.&nbsp;Initial Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"data":
			[
				{"_id":"1", "title":"The Hobbit","numberOfPages":"293"}
			]
}</pre></div></div><br class="example-break"><p>
					You can watch full example at
					<a class="link" href="https://github.com/lordofthejars/nosql-unit/tree/master/nosqlunit-demo" target="_top">github</a>
					.
				</p></div></div></div></div></body></html>