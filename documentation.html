<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>NoSQLUnit Reference Manual</title><link rel="stylesheet" type="text/css" href="stylesheet.css"><meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="book" title="NoSQLUnit Reference Manual"><div class="titlepage"><div><div><h1 class="title"><a name="d445e1"></a>NoSQLUnit Reference Manual</h1></div><div><div class="authorgroup"><div class="author"><h3 class="author"><span class="firstname">Alex</span> <span class="surname">Soto</span></h3><div class="affiliation"><span class="orgname">www.lordofthejars.com<br></span></div></div></div></div><div><p class="releaseinfo">0.7.2
		</p></div><div><p class="copyright">Copyright &copy; 2012 Alex Soto Bueno. Licensed under the Apache License, Version
				2.0 (the "License");
			</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="part"><a href="#nosqlunit-introduction-part">I. NoSQLUnit Core</a></span></dt><dd><dl><dt><span class="chapter"><a href="#introduction">1. NoSQLUnit Core</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e59">Overview</a></span></dt><dt><span class="section"><a href="#d445e135">Requirements</a></span></dt><dt><span class="section"><a href="#d445e160">NoSQLUnit</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e219">Seeding Database</a></span></dt><dt><span class="section"><a href="#d445e306">Verifying Database</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#nosql-support-databases-part">II. Supported Engines</a></span></dt><dd><dl><dt><span class="chapter"><a href="#mongodb">2. MongoDb Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e369">MongoDb</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e436">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e508">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e531">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#neo4j">3. Neo4j Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e890">Neo4j</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e976">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e992">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1056">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#cassandra">4. Cassandra Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1438">Cassandra</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1499">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e1515">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1553">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#redis">5. Redis Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1840">Redis</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1901">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e1917">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1989">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#hbase">6. HBase Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2283">HBase</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2344">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e2360">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e2384">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#couchdb">7. CouchDB Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2687">CouchDB</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2743">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e2759">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e2782">Getting Started</a></span></dt></dl></dd></dl></dd></dl></dd><dt><span class="part"><a href="#advanced-usage-part">III. Advanced Usage</a></span></dt><dd><dl><dt><span class="chapter"><a href="#advanced">8. Advanced Usage</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2989">Embedded In-Memory Redis</a></span></dt><dt><span class="section"><a href="#d445e3107">Managing lifecycle of multiple instances</a></span></dt><dt><span class="section"><a href="#d445e3125">Fast Way</a></span></dt><dt><span class="section"><a href="#d445e3169">Simultaneous engines</a></span></dt><dt><span class="section"><a href="#d445e3261">Support for JSR-330</a></span></dt></dl></dd></dl></dd><dt><span class="part"><a href="#stay-in-touch-part">IV. Stay In Touch</a></span></dt><dd><dl><dt><span class="chapter"><a href="#touch">9. Stay In Touch</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e3328">Future releases</a></span></dt><dt><span class="section"><a href="#d445e3344">Stay in Touch</a></span></dt></dl></dd></dl></dd></dl></div><div class="list-of-tables"><p><b>List of Tables</b></p><dl><dt>1.1. <a href="#d445e275">Load Strategies</a></dt><dt>2.1. <a href="#d445e393">Lifecycle Management Rules</a></dt><dt>2.2. <a href="#d445e421">Manager Rule</a></dt><dt>2.3. <a href="#d445e736">Default In-Memory Configuration Values</a></dt><dt>2.4. <a href="#d445e773">Default Managed Configuration Values</a></dt><dt>3.1. <a href="#d445e911">Lifecycle Management Rules</a></dt><dt>3.2. <a href="#d445e961">Manager Rule</a></dt><dt>3.3. <a href="#d445e1101">Default Embedded Values</a></dt><dt>3.4. <a href="#d445e1144">Default Wrapped Values</a></dt><dt>3.5. <a href="#d445e1190">Default Managed Values</a></dt><dt>3.6. <a href="#d445e1323">Default Managed Connection Values</a></dt><dt>4.1. <a href="#d445e1456">Lifecycle Management Rules</a></dt><dt>4.2. <a href="#d445e1484">Manager Rule</a></dt><dt>4.3. <a href="#d445e1582">Default Embedded Values</a></dt><dt>4.4. <a href="#d445e1644">Default Managed Values</a></dt><dt>5.1. <a href="#d445e1858">Lifecycle Management Rules</a></dt><dt>5.2. <a href="#d445e1886">Manager Rule</a></dt><dt>5.3. <a href="#d445e2018">Default Embedded Values</a></dt><dt>5.4. <a href="#d445e2064">Default Managed Values</a></dt><dt>6.1. <a href="#d445e2301">Lifecycle Management Rules</a></dt><dt>6.2. <a href="#d445e2329">Manager Rule</a></dt><dt>6.3. <a href="#d445e2416">Default Embedded Values</a></dt><dt>6.4. <a href="#d445e2481">Default Managed Values</a></dt><dt>7.1. <a href="#d445e2711">Lifecycle Management Rules</a></dt><dt>7.2. <a href="#d445e2728">Manager Rule</a></dt><dt>7.3. <a href="#d445e2883">Default Managed Configuration Values</a></dt><dt>9.1. <a href="#d445e3347"></a></dt></dl></div><div class="list-of-examples"><p><b>List of Examples</b></p><dl><dt>2.1. <a href="#conf.nosqlunit_dep">NoSqlUnit Maven Repository</a></dt><dt>2.2. <a href="#conf.jmockmongo_repo">jmockmongo Maven Repository</a></dt><dt>2.3. <a href="#conf.jmockmongo_dep">jmockmongo Maven Dependency</a></dt><dt>2.4. <a href="#ex.mongodb_dataset">Example of MongoDb Dataset</a></dt><dt>2.5. <a href="#program.inmemory_conf">In-memory MongoDb</a></dt><dt>2.6. <a href="#program.managed_conf">Managed MongoDb</a></dt><dt>2.7. <a href="#program.managed_specific_conf">Specific Managed MongoDb Configuration</a></dt><dt>2.8. <a href="#program.in_memory_connection_parameters">MongoDbRule with in-memory configuration</a></dt><dt>2.9. <a href="#program.managed_connection_parameters">MongoDbRule with managed configuration</a></dt><dt>2.10. <a href="#program.remote_connection_parameters">MongoDbRule with remote configuration</a></dt><dt>2.11. <a href="#example.book_model">Book POJO</a></dt><dt>2.12. <a href="#example.book_manager">Book POJO</a></dt><dt>2.13. <a href="#example.test_insert_book">Test with Managed Connection</a></dt><dt>2.14. <a href="#example.dataset_book">Initial Dataset</a></dt><dt>2.15. <a href="#example.expected_dataset_book">Expected Dataset</a></dt><dt>3.1. <a href="#conf.nosqlunit_neo4j_dep">NoSqlUnit Maven Repository</a></dt><dt>3.2. <a href="#ex.neo4j_dataset">Example of GraphML Dataset</a></dt><dt>3.3. <a href="#program.neo_inmemory_conf">In-Memory Neo4j</a></dt><dt>3.4. <a href="#program.neo_embedded_conf">Embedded Neo4j</a></dt><dt>3.5. <a href="#program.neo_wrapped_managed_conf">Managed Wrapped Neo4j</a></dt><dt>3.6. <a href="#program.neo_managed_conf">Managed Neo4j</a></dt><dt>3.7. <a href="#program.embedded_connection_neo4j_parameters">Neo4j with embedded configuration</a></dt><dt>3.8. <a href="#program.managed_neo4j_connection_parameters">Neo4j with managed configuration</a></dt><dt>3.9. <a href="#program.matrix_neo4j_manager">Neo4j with managed configuration</a></dt><dt>3.10. <a href="#program.matrix_neo4j_unit">Neo4j with managed configuration</a></dt><dt>3.11. <a href="#program.matrix_neo4j_integration">Neo4j with managed configuration</a></dt><dt>3.12. <a href="#program.expected_neo4j_file">matrix.xml Neo4j file</a></dt><dt>4.1. <a href="#conf.nosqlunit_cassandra_dep">NoSqlUnit Maven Repository</a></dt><dt>4.2. <a href="#ex.cassandra_dataset">Example of Casssandra Dataset</a></dt><dt>4.3. <a href="#program.cassandra_embedded_conf">Embedded Cassandra</a></dt><dt>4.4. <a href="#program.cassandra_managed_conf">Managed Cassandra</a></dt><dt>4.5. <a href="#program.embedded_connection_cassandra_parameters">Cassandra with embedded configuration</a></dt><dt>4.6. <a href="#program.managed_connection_cassandra_parameters">Cassandra with managed configuration</a></dt><dt>4.7. <a href="#program.remote_connection_cassandra_parameters">Cassandra with remote configuration</a></dt><dt>4.8. <a href="#program.person_cassandra_manager">PersonCar cassandra with manager.</a></dt><dt>4.9. <a href="#program.person_cassandra_unit">Cassandra with embedded configuration</a></dt><dt>4.10. <a href="#program.person_cassandra_integration">Cassandra with managed configuration</a></dt><dt>4.11. <a href="#program.expected_cassandra_file">persons.json Cassandra file</a></dt><dt>5.1. <a href="#conf.nosqlunit_redis_dep">NoSqlUnit Maven Repository</a></dt><dt>5.2. <a href="#ex.redis_dataset">Example of Redis Dataset</a></dt><dt>5.3. <a href="#program.redis_embedded_conf">Embedded Redis</a></dt><dt>5.4. <a href="#program.redis_managed_conf">Managed Redis</a></dt><dt>5.5. <a href="#program.embedded_connection_redis_parameters">Redis with embedded configuration</a></dt><dt>5.6. <a href="#program.managed_connection_redis_parameters">Redis with managed configuration</a></dt><dt>5.7. <a href="#program.remote_connection_redis_parameters">Redis with remote configuration</a></dt><dt>5.8. <a href="#program.shard_connection_redis_parameters">Redis with remote configuration</a></dt><dt>5.9. <a href="#program.book_redis_manager">Book manager with Redis</a></dt><dt>5.10. <a href="#program.book_redis_integration">Redis with managed configuration</a></dt><dt>5.11. <a href="#program.expected_redis_file">book.json Redis file</a></dt><dt>6.1. <a href="#conf.nosqlunit_hbase_dep">NoSqlUnit Maven Repository</a></dt><dt>6.2. <a href="#ex.hbase_dataset">Example of HBase Dataset</a></dt><dt>6.3. <a href="#program.hbase_embedded_conf">Embedded HBase</a></dt><dt>6.4. <a href="#program.hbase_managed_conf">Managed HBase</a></dt><dt>6.5. <a href="#program.embedded_connection_hbase_parameters">HBase with embedded configuration</a></dt><dt>6.6. <a href="#program.managed_connection_hbase_parameters">HBase with managed configuration</a></dt><dt>6.7. <a href="#program.coprocessor_hbase_parameters">HBase with coprocessor</a></dt><dt>6.8. <a href="#program.person_hbase_manager">PersonCar cassandra with manager.</a></dt><dt>6.9. <a href="#program.person_hbase_unit">HBase with embedded configuration</a></dt><dt>6.10. <a href="#program.expected_hbase_file">persons.json HBase file</a></dt><dt>7.1. <a href="#conf.couchdb_nosqlunit_dep">NoSqlUnit Maven Repository</a></dt><dt>7.2. <a href="#ex.couchdb_dataset">Example of CouchDB Dataset</a></dt><dt>7.3. <a href="#program.couchdb_managed_conf">Managed CouchDB</a></dt><dt>7.4. <a href="#program.couchdb_managed_connection_parameters">CouchDBRule with managed configuration</a></dt><dt>7.5. <a href="#example.couchdb_book_model">Book POJO</a></dt><dt>7.6. <a href="#example.couchdb_book_manager">Book POJO</a></dt><dt>7.7. <a href="#example.couchdb_test_find_book">Test with Managed Connection</a></dt><dt>7.8. <a href="#example.couchdb_dataset_book">Initial Dataset</a></dt><dt>8.1. <a href="#advanced.instantiate-embedded-redis">Embedded In-Memory Redis.</a></dt><dt>8.2. <a href="#advanced.multipleinstances-database">Multiple Instances of Redis.</a></dt><dt>8.3. <a href="#advanced.fastway-database">Embedded Neo4jRule with defaults.</a></dt><dt>8.4. <a href="#advanced.fastway-managed-database">Managed Cassandra with defaults.</a></dt><dt>8.5. <a href="#advanced.name-database">Given a name database rule</a></dt><dt>8.6. <a href="#advanced.dataset-selective">Selective dataset example</a></dt><dt>8.7. <a href="#advanced.expected-dataset-selective">Selective expectation example</a></dt><dt>8.8. <a href="#advanced.multiple-mongodb">Multiple connections example</a></dt><dt>8.9. <a href="#advanced.injection">Injection example</a></dt><dt>8.10. <a href="#advanced.named-injection">Named injection example</a></dt></dl></div><div class="part" title="Part&nbsp;I.&nbsp;NoSQLUnit Core"><div class="titlepage"><div><div><h1 class="title"><a name="nosqlunit-introduction-part"></a>Part&nbsp;I.&nbsp;NoSQLUnit Core</h1></div></div></div><div class="partintro" title="NoSQLUnit Core"><div></div><p>
				This chapter provides an explanation of why <span class="bold"><strong>NoSQLUnit</strong></span> should be used for testing applications that use <span class="emphasis"><em>NoSQL</em></span> engines as databases. Also will provide an explanation of the main concepts of <span class="bold"><strong>NoSQLUnit</strong></span>.
			</p><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#introduction">1. NoSQLUnit Core</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e59">Overview</a></span></dt><dt><span class="section"><a href="#d445e135">Requirements</a></span></dt><dt><span class="section"><a href="#d445e160">NoSQLUnit</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e219">Seeding Database</a></span></dt><dt><span class="section"><a href="#d445e306">Verifying Database</a></span></dt></dl></dd></dl></dd></dl></div></div><div class="chapter" title="Chapter&nbsp;1.&nbsp;NoSQLUnit Core"><div class="titlepage"><div><div><h2 class="title"><a name="introduction"></a>Chapter&nbsp;1.&nbsp;NoSQLUnit Core</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e59">Overview</a></span></dt><dt><span class="section"><a href="#d445e135">Requirements</a></span></dt><dt><span class="section"><a href="#d445e160">NoSQLUnit</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e219">Seeding Database</a></span></dt><dt><span class="section"><a href="#d445e306">Verifying Database</a></span></dt></dl></dd></dl></div><div class="section" title="Overview"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e59"></a>Overview</h2></div></div></div><span class="inlinemediaobject"><img src="fig/nosqlunitlogo.png"></span><p>
			Unit testing is a method by which the smallest testable part of an
			application is validated. Unit tests must follow the
			<acronym class="acronym">FIRST</acronym>
			Rules; these are Fast, Isolated, Repeatable,
			Self-Validated and
			Timely.
		</p><p>
			It is strange to think about a
			<acronym class="acronym">JEE</acronym>
			application
			without persistence layer (typical Relational databases or
			new
			<span class="emphasis"><em>NoSQL</em></span>
			databases) so should be interesting to write
			unit tests of persistence
			layer too. When we are writing unit tests of
			persistence layer we
			should focus on to not break two main concepts
			of
			<acronym class="acronym">FIRST</acronym>
			rules, the fast and the isolated ones.
		</p><p>
			Our tests will be
			<span class="emphasis"><em>fast</em></span>
			if they don't access
			network nor filesystem, and in case of
			persistence systems network and
			filesystem are the most used
			resources. In case of
			<acronym class="acronym">RDBMS</acronym>
			(
			<span class="emphasis"><em>SQL</em></span>
			), many Java in-memory
			databases exist like
			<span class="application">Apache Derby</span>
			,
			<span class="application">H2</span>
			or
			<span class="application">HSQLDB</span>
			. These
			databases, as their name suggests are embedded into your
			program and data
			are stored in memory, so your tests are still fast.
			The problem is with
			<span class="emphasis"><em>NoSQL</em></span>
			systems, because of their heterogeneity. Some
			systems work using
			Document approach (like
			<span class="application">MongoDb</span>
			), other ones Column (like
			<span class="application">Hbase</span>
			), or Graph (like
			<span class="application">Neo4J</span>
			). For this reason the in-memory mode
			should be provided by the
			vendor, there is no a generic solution.
		</p><p>
			Our tests must be isolated from themselves. It is not acceptable
			that
			one test method modifies the result of another test method. In case
			of persistence tests this scenario occurs when previous test method
			insert
			an entry to database and next test method execution finds the
			change.
			So
			before execution of each test, database should be found in a
			known state.
			Note that if your test found database in a known state,
			test will be
			repeatable, if test assertion depends on previous test
			execution, each
			execution will be unique. For homogeneous systems like
			<acronym class="acronym">RDBMS</acronym>
			,
			<span class="emphasis"><em>DBUnit</em></span>
			exists to maintain
			database in a known state before each execution.
			But there is no like
			<span class="emphasis"><em>DBUnit</em></span>
			framework for heterogeneous
			<span class="emphasis"><em>NoSQL</em></span>
			systems.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			resolves this problem by
			providing a
			<span class="emphasis"><em>JUnit</em></span>
			extension which helps us to manage
			lifecycle of NoSQL systems and also
			take care of maintaining databases
			into known state.
		</p></div><div class="section" title="Requirements"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e135"></a>Requirements</h2></div></div></div><p>
			To run
			<span class="bold"><strong>NoSQLUnit</strong></span>
			,
			<span class="emphasis"><em>JUnit
				4.10
			</em></span>
			or later must be provided. This is because of
			<span class="bold"><strong>NoSQLUnit</strong></span>
			is using
			<span class="emphasis"><em>Rules</em></span>
			, and
			they have changed from previous versions to 4.10.
		</p><p>
			Although it should work with
			<acronym class="acronym">JDK 5</acronym>
			, jars are
			compiled using
			<acronym class="acronym">JDK 6</acronym>
			.
		</p></div><div class="section" title="NoSQLUnit"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e160"></a>NoSQLUnit</h2></div></div></div><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			is a
			<span class="emphasis"><em>JUnit</em></span>
			extension to make writing unit and integration
			tests of systems that
			use NoSQL backend easier and is composed by two sets
			of
			<span class="emphasis"><em>Rules</em></span>
			and a group of annotations.
		</p><p>
			First set of
			<span class="emphasis"><em>Rules</em></span>
			are those responsible of
			managing database lifecycle; there are two
			for each supported
			backend.
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
					The first one (in case it is possible) it is the
					<span class="bold"><strong>in-memory</strong></span>
					mode. This mode takes care of
					starting and stopping database system
					in
					"
					<span class="emphasis"><em>in-memory</em></span>
					" mode. This mode will be typically
					used during unit testing
					execution.
				</p></li><li class="listitem"><p>
					The second one is the
					<span class="bold"><strong>managed</strong></span>
					mode. This mode is in charge of starting
					<span class="emphasis"><em>NoSQL</em></span>
					server but as remote process (in local machine) and stopping it.
					This
					will typically used during integration testing execution.
				</p></li></ul></div><p>
			Second set of
			<span class="emphasis"><em>Rules</em></span>
			are those responsible of
			maintaining database into known state. Each
			supported backend will have
			its own, and can be understood as a
			connection to defined database which
			will be used to execute the
			required operations for maintaining the
			stability of the system.
		</p><p>
			Note that because
			<span class="emphasis"><em>NoSQL</em></span>
			databases are
			heterogeneous, each system will require its own
			implementation.
		</p><p>
			And finally two annotations are provided,
			<a class="link" href="#seeding_database">@UsingDataSet</a>
			and
			<a class="link" href="#verifying_database">@ShouldMatchDataSet</a>
			, (thank you so
			much
			<span class="emphasis"><em>Arquillian</em></span>
			people for the name).
		</p><div class="section" title="Seeding Database"><div class="titlepage"><div><div><h3 class="title"><a name="d445e219"></a>Seeding Database</h3></div></div></div><p>
				@UsingDataSet is used to seed database with defined data set. In
				brief data sets are files that contain all data to be inserted to
				configured database. In order to seed your database, use
				<span class="emphasis"><em>@UsingDataSet</em></span>
				annotation, you can define it either
				on the test itself or on the
				class level. If there is definition on
				both, test level annotation
				takes precedence. This annotation has
				two
				attributes
				<code class="methodname">locations</code>
				and
				<code class="methodname">loadStrategy</code>
				.
			</p><p>
				With
				<code class="methodname">locations</code>
				attribute you can specify
				<span class="bold"><strong>classpath</strong></span>
				datasets location. Locations
				are relative to test class location.
				Note that more than one dataset
				can
				be specified. 
			</p><p>
			Also <code class="methodname">withSelectiveLocations</code> attribute can be used to specify datasets location. See <a class="link" href="#advanced.simultaneous-engine-title">Advanced Usage</a> chapter for more information.
			</p><p>
				If files are not
				specified explicitly, next strategy is
				applied:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
						First searches for a file on classpath in same package of test
						class with next file name,
						<code class="filename">[test class name]#[test method
							name].[format]
						</code>
						(only if annotation is present at test
						method).
					</p></li><li class="listitem"><p>
						If first rule is not met or annotation is defined at class
						scope,
						next file is searched on classpath in same package of test
						class,
						<code class="filename">[test class name].[default format]</code>
						.
					</p></li></ul></div><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					datasets must reside into
					<span class="emphasis"><em>classpath</em></span>
					and
					format depends on
					<span class="emphasis"><em>NoSQL</em></span>
					vendor.
				</p></div><p>Second attribute provides strategies for inserting data.
				Implemented strategies are:
			</p><table border="1" id="d445e275"><caption>Table&nbsp;1.1.&nbsp;Load Strategies</caption><tr>
					<td>INSERT</td>

					<td>Insert defined datasets before executing any test method.</td>
				</tr><tr>
					<td>DELETE_ALL</td>

					<td>Deletes all elements of database before executing any test
						method.
					</td>
				</tr><tr>
					<td>CLEAN_INSERT</td>

					<td>This is the most used strategy. It deletes all elements of
						database and then insert defined datasets before executing any
						test
						method.
					</td>
				</tr></table><p>An example of usage:</p><pre class="programlisting">@UsingDataSet(locations=<strong class="hl-string"><em style="color:red">"my_data_set.json"</em></strong>, loadStrategy=LoadStrategyEnum.INSERT)</pre></div><div class="section" title="Verifying Database"><div class="titlepage"><div><div><h3 class="title"><a name="d445e306"></a>Verifying Database</h3></div></div></div><p>
				Sometimes it might imply a huge amount of work asserting database
				state directly from testing code. By using
				<span class="emphasis"><em>@ShouldMatchDataSet</em></span>
				on test method,
				<span class="bold"><strong>NoSQLUnit</strong></span>
				will check if database contains
				expected entries after test
				execution. As with
				<span class="emphasis"><em>@ShouldMatchDataSet</em></span>
				annotation you can define
				classpath file location, or using <code class="methodname">withSelectiveMatcher</code> See <a class="link" href="#advanced.simultaneous-engine-title">Advanced Usage</a> chapter for more information. 
			</p><p>
			If it is not dataset is supplied next convention is	used:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
						First searches for a file on classpath in same package of test
						class with next file name,
						<code class="filename">[test class name]#[test method
							name]-expected.[format]
						</code>
						(only if annotation is present at
						test method).
					</p></li><li class="listitem"><p>
						If first rule is not met or annotation is defined at class
						scope,
						file is searched on classpath in same package of test class,
						<code class="filename">[test class name]-expected.[default format]</code>
						.
					</p></li></ul></div><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					datasets must reside into
					<span class="emphasis"><em>classpath</em></span>
					and
					format depends on
					<span class="emphasis"><em>NoSQL</em></span>
					vendor.
				</p></div><p>An example of usage:</p><pre class="programlisting">@ShouldMatchDataSet(location=<strong class="hl-string"><em style="color:red">"my_expected_data_set.json"</em></strong>)</pre></div></div></div></div><div class="part" title="Part&nbsp;II.&nbsp;Supported Engines"><div class="titlepage"><div><div><h1 class="title"><a name="nosql-support-databases-part"></a>Part&nbsp;II.&nbsp;Supported Engines</h1></div></div></div><div class="partintro" title="Supported Engines"><div></div><p>
				This chapter provides an overview of supported <span class="emphasis"><em>NoSQL</em></span> databases, and how to write tests for them, using <span class="bold"><strong>NoSQLUnit</strong></span>. 
			</p><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#mongodb">2. MongoDb Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e369">MongoDb</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e436">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e508">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e531">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#neo4j">3. Neo4j Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e890">Neo4j</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e976">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e992">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1056">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#cassandra">4. Cassandra Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1438">Cassandra</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1499">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e1515">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1553">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#redis">5. Redis Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1840">Redis</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1901">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e1917">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1989">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#hbase">6. HBase Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2283">HBase</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2344">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e2360">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e2384">Getting Started</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#couchdb">7. CouchDB Engine</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2687">CouchDB</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2743">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e2759">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e2782">Getting Started</a></span></dt></dl></dd></dl></dd></dl></div></div><div class="chapter" title="Chapter&nbsp;2.&nbsp;MongoDb Engine"><div class="titlepage"><div><div><h2 class="title"><a name="mongodb"></a>Chapter&nbsp;2.&nbsp;MongoDb Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e369">MongoDb</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e436">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e508">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e531">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="MongoDb"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e369"></a>MongoDb</h2></div></div></div><p>
			<span class="application">MongoDb</span>
			is a
			<span class="emphasis"><em>NoSQL</em></span>
			database that stores structured data as
			<span class="emphasis"><em>JSON-like</em></span>
			documents with dynamic schemas.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>MongoDb</em></span>
			by using next classes:
		</p><p>
		</p><table border="1" id="d445e393"><caption>Table&nbsp;2.1.&nbsp;Lifecycle Management Rules</caption><tr>
				<td>In Memory</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDb
					</code>
				</td>
			</tr><tr>
				<td>Managed</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb
					</code>
				</td>
			</tr></table><p>
		</p><p>
		</p><table border="1" id="d445e421"><caption>Table&nbsp;2.2.&nbsp;Manager Rule</caption><tr>
				<td>NoSQLUnit Management</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.mongodb.MongoDbRule
					</code>
				</td>
			</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d445e436"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">MongoDb</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_dep"></a><p class="title"><b>Example&nbsp;2.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-mongodb<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"><p>
				Note that if you are plannig to use
				<span class="bold"><strong>in-memory</strong></span>
				approach an extra dependency is
				required.
				<span class="bold"><strong>In-memory</strong></span>
				mode is implemented
				using
				<span class="emphasis"><em>jmockmongo</em></span>
				.
				<span class="emphasis"><em>JMockmongo</em></span>
				is a new project that help with unit testing Java-based
				<span class="application">MongoDb</span>
				Applications by starting an
				in-process
				<span class="emphasis"><em>Netty</em></span>
				server that speaks the
				<span class="emphasis"><em>MongoDb</em></span>
				protocol and maintains databases and
				collections in
				<acronym class="acronym">JVM</acronym>
				memory. It is not a true embedded
				mode becuase it will starts a server, but in fact for now it is the best
				way to write
				<span class="application">MongoDb</span>
				unit tests. As his
				author says it is an incomplete tool and will be improved every time a
				new feature is required.
			</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
					During development of this documentation, current
					<span class="emphasis"><em>jmockmongo</em></span>
					version was 0.0.2-SNAPSHOT. Author is
					imporoving version often so before using one specific version, take a
					look at its
					<a class="link" href="https://github.com/thiloplanz/jmockmongo" target="_top">website</a>
					.
				</p></div><p>
				To install add next
				<a class="link" href="#conf.jmockmongo_repo" title="Example&nbsp;2.2.&nbsp;jmockmongo Maven Repository">
					repository
				</a>
				and
				<a class="link" href="#conf.jmockmongo_dep" title="Example&nbsp;2.3.&nbsp;jmockmongo Maven Dependency">
					dependency
				</a>
				:
			</p><div class="example"><a name="conf.jmockmongo_repo"></a><p class="title"><b>Example&nbsp;2.2.&nbsp;jmockmongo Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;repositories&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;repository&gt;</strong>
		<strong class="hl-tag" style="color: #000096">&lt;id&gt;</strong>thiloplanz-snapshot<strong class="hl-tag" style="color: #000096">&lt;/id&gt;</strong>
		<strong class="hl-tag" style="color: #000096">&lt;url&gt;</strong>http://repository-thiloplanz.forge.cloudbees.com/snapshot/<strong class="hl-tag" style="color: #000096">&lt;/url&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;/repository&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/repositories&gt;</strong></pre></div></div><br class="example-break"><div class="example"><a name="conf.jmockmongo_dep"></a><p class="title"><b>Example&nbsp;2.3.&nbsp;jmockmongo Maven Dependency</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>jmockmongo<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>jmockmongo<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${mongomock.version}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d445e508"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>MongoDb</em></span>
				module
				is
				<span class="emphasis"><em>json</em></span>
				.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.mongodb_dataset" title="Example&nbsp;2.4.&nbsp;Example of MongoDb Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.mongodb_dataset"></a><p class="title"><b>Example&nbsp;2.4.&nbsp;Example of MongoDb Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"name_collection1": [
	{
		"attribute_1":"value1",
		"attribute_2":"value2"
	},
	{
		"attribute_3":2,
		"attribute_4":"value4"
	}
	],
	"name_collection2": [
		...
	],
	....
}</pre></div></div><br class="example-break"><p>Notice that if attributes value are integers, double quotes are
				not required.
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d445e531"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d445e534"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you
					will require an
					<span class="bold"><strong>in-memory</strong></span>
					approach,
					<span class="bold"><strong>managed</strong></span>
					approach or
					<span class="bold"><strong>remote</strong></span>
					approach.
				</p><p>
					To configure
					<span class="bold"><strong>in-memory</strong></span>
					approach
					you should only instantiate next
					<a class="link" href="#program.inmemory_conf" title="Example&nbsp;2.5.&nbsp;In-memory MongoDb">rule</a>
					:
				</p><div class="example"><a name="program.inmemory_conf"></a><p class="title"><b>Example&nbsp;2.5.&nbsp;In-memory MongoDb</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
InMemoryMongoDb inMemoryMongoDb = <strong class="hl-keyword">new</strong> InMemoryMongoDb();</pre></div></div><br class="example-break"><p>
					To configure the
					<span class="bold"><strong>managed</strong></span>
					way,
					you should use
					<code class="classname">ManagedMongoDb</code>
					rule and may
					require some <a class="link" href="#program.managed_conf" title="Example&nbsp;2.6.&nbsp;Managed MongoDb">configuration</a> parameters.
				</p><div class="example"><a name="program.managed_conf"></a><p class="title"><b>Example&nbsp;2.6.&nbsp;Managed MongoDb</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.MongoServerRuleBuilder.newManagedMongoDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb = newManagedMongoDbRule().build();</pre></div></div><br class="example-break"><p>
					By default managed
					<span class="emphasis"><em>MongoDb</em></span>
					rule uses next
					default values:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>MongoDb</em></span>
							installation directory is
							retrieved from
							<code class="varname">MONGO_HOME</code>
							system environment
							variable.
						</p></li><li class="listitem"><p>
							Target path, that is the directory where
							<span class="emphasis"><em>MongoDb</em></span>
							server is started, is
							<code class="constant">target/mongo-temp</code>
							.
						</p></li><li class="listitem"><p>
							Database path is at
							<em class="parameter"><code>{target
								path}
							</code></em>
							<code class="constant">/mongo-dbpath</code>
							.
						</p></li><li class="listitem"><p>
							Because after execution of tests all generated data is
							removed, in
							<em class="parameter"><code>{target
								path}
							</code></em>
							<code class="constant">/logpath</code>
							will remain log
							file generated by the server.
						</p></li><li class="listitem"><p>
							In
							<span class="emphasis"><em>Windows</em></span> systems
							executable should be found as
							<code class="filename">bin/mongod.exe</code>
							meanwhile in
							<span class="emphasis"><em>MAC
								OS
							</em></span>
							and
							<span class="emphasis"><em>*nix</em></span>
							should be found as
							<code class="filename">bin/mongod</code>
							.
						</p></li></ul></div><p>
					<code class="classname">ManagedMongoDb</code>
					can be created from
					scratch, but for making life easier, a
					<span class="emphasis"><em>DSL</em></span>
					is
					provided using
					<code class="classname">MongoServerRuleBuilder</code>
					class.
					For
					<a class="link" href="#program.managed_specific_conf" title="Example&nbsp;2.7.&nbsp;Specific Managed MongoDb Configuration">example</a>
					:
				</p><div class="example"><a name="program.managed_specific_conf"></a><p class="title"><b>Example&nbsp;2.7.&nbsp;Specific Managed MongoDb Configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.MongoServerRuleBuilder.newManagedMongoDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb =
newManagedMongoDbRule().mongodPath(<strong class="hl-string"><em style="color:red">"/opt/mongo"</em></strong>).appendSingleCommandLineArguments(<strong class="hl-string"><em style="color:red">"-vvv"</em></strong>).build();</pre></div></div><br class="example-break"><p>
					In
					<a class="link" href="#program.managed_specific_conf" title="Example&nbsp;2.7.&nbsp;Specific Managed MongoDb Configuration">example</a>
					we are overriding
					<code class="varname">MONGO_HOME</code>
					variable (in case has
					been set) and set mongo home at
					<code class="filename">/opt/mongo</code>
					.
					Moreover we are appending a single argument to
					<span class="emphasis"><em>MongoDb</em></span>
					executable, in this case setting log
					level to number 3 (-vvv). Also you can append
					<span class="emphasis"><em>property=value</em></span>
					arguments using
					<code class="function">appendCommandLineArguments(String argumentName, String
						argumentValue)
					</code>
					method.
				</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>when you are specifying command line arguments, remember to
						add slash (-) and double slash (--) where is necessary.
					</p></div><p>
					To stop
					<span class="emphasis"><em>MongoDb</em></span>
					instance,
					<span class="bold"><strong>NoSQLUnit</strong></span>
					sends a
					<code class="function">shutdown</code>
					command to server using
					<span class="emphasis"><em>Java Mongo AP</em></span>
					I. When this
					command is sent, the server is stopped and because connection is lost,
					<span class="emphasis"><em>Java Mongo API</em></span>
					logs automatically an exception
					(read
					<a class="link" href="https://groups.google.com/group/mongodb-user/browse_thread/thread/ac9a4c9ea13f3e81" target="_top">here</a>
					information about the problem and how to "resolve" it). Do not
					confuse
					with a testing failure. You will see something like:
				</p><pre class="screen">java.io.EOFException
	at org.bson.io.Bits.readFully(Bits.java:37)
	at org.bson.io.Bits.readFully(Bits.java:28)
	at com.mongodb.Response.&lt;init&gt;;(Response.java:39)
	at com.mongodb.DBPort.go(DBPort.java:128)
	at com.mongodb.DBPort.call(DBPort.java:79)
	at com.mongodb.DBTCPConnector.call(DBTCPConnector.java:218)
	at com.mongodb.DBApiLayer$MyCollection.__find(DBApiLayer.java:305)
	at com.mongodb.DB.command(DB.java:160)
	at com.mongodb.DB.command(DB.java:183)
	at com.mongodb.DB.command(DB.java:144)
	at
	com.lordofthejars.nosqlunit.mongodb.MongoDbLowLevelOps.shutdown(MongoDbLowLevelOps.java:44)
	at
	com.lordofthejars.nosqlunit.mongodb.ManagedMongoDb.after(ManagedMongoDb.java:157)
	at
	org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:48)
	at org.junit.rules.RunRules.evaluate(RunRules.java:18)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:300)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:236)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:134)
	at
	org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:113)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at
	sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
	at
	sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:616)
	at
	org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)
	at
	org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)
	at
	org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)
	at
	org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:103)
	at
	org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:74)</pre><p>
					Configuring
					<span class="bold"><strong>remote</strong></span>
					approach
					does not require any special rule because you (or System like
					<span class="application">Maven</span>
					) is the responsible of starting and
					stopping the server. This mode is used in deployment tests where you
					are testing your application on real environment.
				</p></div><div class="section" title="Configuring MongoDb Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d445e709"></a>Configuring MongoDb Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="emphasis"><em>
						<span class="bold"><strong>Mongodb</strong></span>
					</em></span>
					rule in charge of
					maintaining
					<span class="emphasis"><em>MongoDb</em></span>
					database into known state by
					inserting and deleting defined datasets. You must register
					<code class="classname">MongoDbRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule
					class, which requires a configuration parameter with information like
					host, port or database name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects. Two
					different kind of configuration builders exist.
				</p><p>
					The first one is for configuring a connection to in-memory
					<span class="emphasis"><em>jmockmongo</em></span>
					server. Default connection values
					are:
				</p><table border="1" id="d445e736"><caption>Table&nbsp;2.3.&nbsp;Default In-Memory Configuration Values</caption><tr>
						<td>Host</td>

						<td>0.0.0.0</td>
					</tr><tr>
						<td>Port</td>

						<td>2307</td>
					</tr></table><p>
					Notice that these values are the default ones of
					<span class="emphasis"><em>jmockmongo</em></span>
					project, so if you are thinking to use
					<span class="emphasis"><em>jmockmongo</em></span>
					, no modifications are required.
				</p><div class="example"><a name="program.in_memory_connection_parameters"></a><p class="title"><b>Example&nbsp;2.8.&nbsp;MongoDbRule with in-memory configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.InMemoryMongoDbConfigurationBuilder.inMemoryMongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(inMemoryMongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());</pre></div></div><br class="example-break"><p>
					The second one is for configuring a connection to remote
					<span class="emphasis"><em>MongoDb</em></span>
					server. Default values are:
				</p><table border="1" id="d445e773"><caption>Table&nbsp;2.4.&nbsp;Default Managed Configuration Values</caption><tr>
						<td>Host</td>

						<td>localhost</td>
					</tr><tr>
						<td>Port</td>

						<td>27017</td>
					</tr><tr>
						<td>Authentication</td>

						<td>No authentication parameters.</td>
					</tr></table><div class="example"><a name="program.managed_connection_parameters"></a><p class="title"><b>Example&nbsp;2.9.&nbsp;MongoDbRule with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.MongoDbConfigurationBuilder.mongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());</pre></div></div><br class="example-break"><div class="example"><a name="program.remote_connection_parameters"></a><p class="title"><b>Example&nbsp;2.10.&nbsp;MongoDbRule with remote configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.mongodb.MongoDbConfigurationBuilder.mongoDb;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).host(<strong class="hl-string"><em style="color:red">"my_remote_host"</em></strong>).build());</pre></div></div><br class="example-break"></div><div class="section" title="Complete Example"><div class="titlepage"><div><div><h4 class="title"><a name="d445e810"></a>Complete Example</h4></div></div></div><p>
					Consider a library application, which apart from multiple
					operations, it allow us to add new books to system. Our
					<a class="link" href="#example.book_model" title="Example&nbsp;2.11.&nbsp;Book POJO">model</a>
					is as simple as:
				</p><div class="example"><a name="example.book_model"></a><p class="title"><b>Example&nbsp;2.11.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> Book {

	<strong class="hl-keyword">private</strong> String title;

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">int</strong> numberOfPages;

	<strong class="hl-keyword">public</strong> Book(String title, <strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">super</strong>();
		<strong class="hl-keyword">this</strong>.title = title;
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setTitle(String title) {
		<strong class="hl-keyword">this</strong>.title = title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setNumberOfPages(<strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}


	<strong class="hl-keyword">public</strong> String getTitle() {
		<strong class="hl-keyword">return</strong> title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">int</strong> getNumberOfPages() {
		<strong class="hl-keyword">return</strong> numberOfPages;
	}
}</pre></div></div><br class="example-break"><p>
					Next business
					<a class="link" href="#example.book_manager" title="Example&nbsp;2.12.&nbsp;Book POJO">class</a>
					is the responsible of managing access to
					<span class="emphasis"><em>MongoDb</em></span>
					server:
				</p><div class="example"><a name="example.book_manager"></a><p class="title"><b>Example&nbsp;2.12.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> BookManager {

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> Logger LOGGER = LoggerFactory.getLogger(BookManager.<strong class="hl-keyword">class</strong>);

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> MongoDbBookConverter MONGO_DB_BOOK_CONVERTER = <strong class="hl-keyword">new</strong>	MongoDbBookConverter();
	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> DbObjectBookConverter DB_OBJECT_BOOK_CONVERTER = <strong class="hl-keyword">new</strong> DbObjectBookConverter();

			
	<strong class="hl-keyword">private</strong> DBCollection booksCollection;

	<strong class="hl-keyword">public</strong> BookManager(DBCollection booksCollection) {
		<strong class="hl-keyword">this</strong>.booksCollection = booksCollection;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> create(Book book) {
		DBObject dbObject = MONGO_DB_BOOK_CONVERTER.convert(book);
		booksCollection.insert(dbObject);
	}
}</pre></div></div><br class="example-break"><p>
					And now it is time for testing. In next
					<a class="link" href="#example.test_insert_book" title="Example&nbsp;2.13.&nbsp;Test with Managed Connection">test</a>
					we are going to
					validate that a book is inserted correctly into database.
				</p><div class="example"><a name="example.test_insert_book"></a><p class="title"><b>Example&nbsp;2.13.&nbsp;Test with Managed Connection</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">package</strong> com.lordofthejars.nosqlunit.demo.mongodb;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenANewBookIsCreated {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedMongoDb managedMongoDb = newManagedMongoDbRule().mongodPath(<strong class="hl-string"><em style="color:red">"/opt/mongo"</em></strong>).build();

	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb().databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build());

	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="initialData.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<em><span class="hl-annotation" style="color: gray">@ShouldMatchDataSet(location="expectedData.json")</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> book_should_be_inserted_into_repository() {

		BookManager bookManager = <strong class="hl-keyword">new</strong> BookManager(MongoDbUtil.getCollection(Book.<strong class="hl-keyword">class</strong>.getSimpleName()));

		Book book = <strong class="hl-keyword">new</strong> Book(<strong class="hl-string"><em style="color:red">"The Lord Of The Rings"</em></strong>, <span class="hl-number">1299</span>);
		bookManager.create(book);
	}

}</pre></div></div><br class="example-break"><p>
					In
					<a class="link" href="#example.test_insert_book" title="Example&nbsp;2.13.&nbsp;Test with Managed Connection">previous</a>
					test
					we have defined that
					<span class="emphasis"><em>MongoDb</em></span>
					will be managed by
					test by starting an instance of server located at
					<code class="filename">/opt/mongo</code>
					. Moreover we are setting an
					<a class="link" href="#example.dataset_book" title="Example&nbsp;2.14.&nbsp;Initial Dataset">initial</a>
					dataset in file
					<code class="filename">initialData.json</code>
					located at classpath
					<code class="filename">com/lordofthejars/nosqlunit/demo/mongodb/initialData.json
					</code>
					and
					<a class="link" href="#example.expected_dataset_book" title="Example&nbsp;2.15.&nbsp;Expected Dataset">expected</a>
					dataset called
					<code class="filename">expectedData.json</code>
					.
				</p><div class="example"><a name="example.dataset_book"></a><p class="title"><b>Example&nbsp;2.14.&nbsp;Initial Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"Book":
	[
		{"title":"The Hobbit","numberOfPages":293}
	]
}</pre></div></div><br class="example-break"><div class="example"><a name="example.expected_dataset_book"></a><p class="title"><b>Example&nbsp;2.15.&nbsp;Expected Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"Book":
	[
		{"title":"The Hobbit","numberOfPages":293},
		{"title":"The Lord Of The Rings","numberOfPages":1299}
	]
}</pre></div></div><br class="example-break"><p>
					You can watch full example at
					<a class="link" href="https://github.com/lordofthejars/nosql-unit/tree/master/nosqlunit-demo" target="_top">github</a>
					.
				</p></div></div></div></div><div class="chapter" title="Chapter&nbsp;3.&nbsp;Neo4j Engine"><div class="titlepage"><div><div><h2 class="title"><a name="neo4j"></a>Chapter&nbsp;3.&nbsp;Neo4j Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e890">Neo4j</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e976">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e992">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1056">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="Neo4j"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e890"></a>Neo4j</h2></div></div></div><p>
			<span class="application">Neo4j</span>
			is a high-performance,
			<span class="emphasis"><em>NoSQL</em></span>
			graph database with all the features of a mature and robust database.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>Neo4j</em></span>
			by using next classes:
		</p><p>
			</p><table border="1" id="d445e911"><caption>Table&nbsp;3.1.&nbsp;Lifecycle Management Rules</caption><tr>
					<td>In Memory</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.neo4j.InMemoryNeo4j
						</code>
					</td>
				</tr><tr>
					<td>Embedded</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.neo4j.EmbeddedNeo4j
						</code>
					</td>
				</tr><tr>
					<td>Managed Wrapping</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.neo4j.ManagedWrappingNeoServer
						</code>
					</td>
				</tr><tr>
					<td>Managed</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.neo4j.ManagedNeoServer
						</code>
					</td>
				</tr></table><p>
		</p><p>
			</p><table border="1" id="d445e961"><caption>Table&nbsp;3.2.&nbsp;Manager Rule</caption><tr>
					<td>NoSQLUnit Management</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.neo4j.Neo4jRule
						</code>
					</td>
				</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d445e976"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">Neo4j</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_neo4j_dep"></a><p class="title"><b>Example&nbsp;3.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-neo4j<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d445e992"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>Neo4j</em></span>
				module is
				<a class="link" href="http://graphml.graphdrawing.org/" target="_top">GraphML</a>
				.
				<span class="emphasis"><em>GraphML</em></span>
				is a comprehensive and easy-to-use file format for graphs.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.neo4j_dataset" title="Example&nbsp;3.2.&nbsp;Example of GraphML Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.neo4j_dataset"></a><p class="title"><b>Example&nbsp;3.2.&nbsp;Example of GraphML Dataset</b></p><div class="example-contents"><pre class="programlisting"><span class="hl-directive" style="color: maroon">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<strong class="hl-tag" style="color: #000096">&lt;graphml</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://graphml.graphdrawing.org/xmlns"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;key</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"attr1"</span> <span class="hl-attribute" style="color: #F5844C">for</span>=<span class="hl-value" style="color: #993300">"edge"</span> <span class="hl-attribute" style="color: #F5844C">attr.name</span>=<span class="hl-value" style="color: #993300">"attr1"</span> <span class="hl-attribute" style="color: #F5844C">attr.type</span>=<span class="hl-value" style="color: #993300">"float"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;key</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"attr2"</span> <span class="hl-attribute" style="color: #F5844C">for</span>=<span class="hl-value" style="color: #993300">"node"</span> <span class="hl-attribute" style="color: #F5844C">attr.name</span>=<span class="hl-value" style="color: #993300">"attr2"</span> <span class="hl-attribute" style="color: #F5844C">attr.type</span>=<span class="hl-value" style="color: #993300">"string"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;graph</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"G"</span> <span class="hl-attribute" style="color: #F5844C">edgedefault</span>=<span class="hl-value" style="color: #993300">"directed"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"attr2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>value1<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"attr2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>value2<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"7"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"1"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"2"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"label1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"attr1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>float<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/graph&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/graphml&gt;</strong></pre></div></div><br class="example-break"><p>
				where:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>graphml</em></span>
							: the root element of the GraphML document
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>key</em></span>
							: description for graph element properties, you must define if
							property type is for nodes or relationships, name, and type of
							element. In our case string, int, long, float, double and boolean
							are supported.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>graph</em></span>
							: the beginning of the graph representation. In our case only one
							level of graphs are supported. Inner graphs will be ignored.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>node</em></span>
							: the beginning of a vertex representation. Please note that id 0
							is reserved for reference node, so cannot be used as id.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>edge</em></span>
							: the beginning of an edge representation. Source and target
							attributes are filled with node id. If you want to link with
							reference node, use a 0 which is the id of root node. Note that
							label attribute is not in defined in standard definition of
							GraphML specification; GraphML supports adding new attributes to
							all GrpahML elements, and label attribute has been added to
							facilitate the creation of edge labels.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>data</em></span>
							: the key/value data associated with a graph element. Data value
							will be validated against type defined in key element.
						</p></li></ul></div><p>
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1056"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1059"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you will require an in-memory approach, embedded approach, managed
					approach or remote
					approach.
				</p><div class="section" title="In-memory Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1064"></a>In-memory Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>in-memory</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.neo_inmemory_conf" title="Example&nbsp;3.3.&nbsp;In-Memory Neo4j">rule</a>
						:
					</p><div class="example"><a name="program.neo_inmemory_conf"></a><p class="title"><b>Example&nbsp;3.3.&nbsp;In-Memory Neo4j</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.InMemoryNeo4j.InMemoryNeo4jRuleBuilder.newInMemoryNeo4j;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> InMemoryNeo4j inMemoryNeo4j = newInMemoryNeo4j().build();</pre></div></div><br class="example-break"></div><div class="section" title="Embedded Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1080"></a>Embedded Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>embedded</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.neo_embedded_conf" title="Example&nbsp;3.4.&nbsp;Embedded Neo4j">rule</a>
						:
					</p><div class="example"><a name="program.neo_embedded_conf"></a><p class="title"><b>Example&nbsp;3.4.&nbsp;Embedded Neo4j</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.EmbeddedNeo4j.EmbeddedNeo4jRuleBuilder.newEmbeddedNeo4jRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedNeo4j embeddedNeo4j = newEmbeddedNeo4jRule().build();</pre></div></div><br class="example-break"><p>
						By default embedded
						<span class="emphasis"><em>Neo4j</em></span>
						rule uses next
						default values:
					</p><table id="d445e1101"><caption>Table&nbsp;3.3.&nbsp;Default Embedded Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>Neo4j</em></span>
								server is started and is
								<code class="constant">target/neo4j-temp</code>
								.
							</td>
						</tr></table></div><div class="section" title="Managed Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1118"></a>Managed Lifecycle</h5></div></div></div><p>To configure managed way, two possible approaches can be
						used:
					</p><p>
						The first one is using an
						<span class="bold"><strong>embedded database wrapped by a server
						</strong></span>
						.
						This is a way to give an embedded database visibility through
						network (internally we are creating a
						<code class="classname">WrappingNeoServerBootstrapper</code>
						instance)
						:
					</p><div class="example"><a name="program.neo_wrapped_managed_conf"></a><p class="title"><b>Example&nbsp;3.5.&nbsp;Managed Wrapped Neo4j</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.ManagedWrappingNeoServer.ManagedWrappingNeoServerRuleBuilder.newWrappingNeoServerNeo4jRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedWrappingNeoServer managedWrappingNeoServer = newWrappingNeoServerNeo4jRule().port(<span class="hl-number">8888</span>).build();</pre></div></div><br class="example-break"><p>
						By default wrapped managed
						<span class="emphasis"><em>Neo4j</em></span>
						rule uses next
						default values, but can be configured
						programmatically as shown in previous
						<a class="link" href="#program.neo_wrapped_managed_conf" title="Example&nbsp;3.5.&nbsp;Managed Wrapped Neo4j">example</a>
						:
					</p><table id="d445e1144"><caption>Table&nbsp;3.4.&nbsp;Default Wrapped Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								The directory where
								<span class="emphasis"><em>Neo4j</em></span>
								server is started and is
								<code class="constant">target/neo4j-temp</code>
								.
							</td>
						</tr><tr>
							<td>
								Port
							</td>
							<td>
								Where server is listening incoming messages is 7474.
							</td>
						</tr></table><p>
						The second strategy is
						<span class="bold"><strong>starting and stopping an already installed
							server
						</strong></span>
						on executing machine, by calling start and stop command lines.
						Next
						<a class="link" href="#program.neo_managed_conf" title="Example&nbsp;3.6.&nbsp;Managed Neo4j">rule</a>
						should be registered:
					</p><div class="example"><a name="program.neo_managed_conf"></a><p class="title"><b>Example&nbsp;3.6.&nbsp;Managed Neo4j</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.ManagedNeoServer.Neo4jServerRuleBuilder.newManagedNeo4jServerRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedNeoServer managedNeoServer = newManagedNeo4jServerRule().neo4jPath(<strong class="hl-string"><em style="color:red">"/opt/neo4j"</em></strong>).build();</pre></div></div><br class="example-break"><p>
						By default managed
						<span class="emphasis"><em>Neo4j</em></span>
						rule uses next
						default values, but can be configured
						programmatically as shown in previous
						<a class="link" href="#program.neo_managed_conf" title="Example&nbsp;3.6.&nbsp;Managed Neo4j">example</a>
						:
					</p><table border="1" id="d445e1190"><caption>Table&nbsp;3.5.&nbsp;Default Managed Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>Neo4j</em></span>
								process will be started and by default is
								<code class="constant">target/neo4j-temp</code>
								.
							</td>
						</tr><tr>
							<td>
								Port
							</td>
							<td>
								Where server is listening incoming messages is 7474.
							</td>
						</tr><tr>
							<td>
								Neo4jPath
							</td>
							<td>
								<span class="emphasis"><em>Neo4j</em></span>
								installation directory which by default is
								retrieved from
								<code class="varname">NEO4J_HOME</code>
								system environment
								variable.
							</td>
						</tr></table><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
							Versions prior to
							<span class="emphasis"><em>Neo4j</em></span>
							1.8, port cannot be configured from command line, and port should
							be changed manually in
							<code class="filename">conf/neo4j-server.properties</code>
							. Although this restriction, if you have configured
							<span class="emphasis"><em>Neo4j</em></span>
							to run through a different port, it should be specified too in
							<code class="classname">ManagedNeoServer</code>
							rule.
						</p></div></div><div class="section" title="Remote Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1244"></a>Remote Lifecycle</h5></div></div></div><p>
						Configuring
						<span class="bold"><strong>remote</strong></span>
						approach
						does not require any special rule because you (or System
						like
						<span class="application">Maven</span>
						) is the responsible of starting and
						stopping the server. This mode
						is used in deployment tests where you
						are testing your application
						on real environment.
					</p></div></div><div class="section" title="Configuring Neo4j Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1255"></a>Configuring Neo4j Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="bold"><strong>Neo4j</strong></span>
					rule in charge of maintaining
					<span class="emphasis"><em>Neo4j</em></span>
					graph into known state by inserting and deleting defined
					datasets.
					You must register
					<code class="classname">Neo4jRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule class, which
					requires a configuration parameter with
					information like host,
					port, uri or target directory.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects.
					Two
					different kind of configuration builders exist.
				</p><div class="section" title="In-Memory/Embedded Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1274"></a>In-Memory/Embedded Connection</h5></div></div></div><p>
						The first one is for configuring a connection to
						in-memory/embedded
						<span class="emphasis"><em>Neo4j</em></span>
						.
					</p><div class="example"><a name="program.embedded_connection_neo4j_parameters"></a><p class="title"><b>Example&nbsp;3.7.&nbsp;Neo4j with embedded configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.EmbeddedNeoServerConfigurationBuilder.newEmbeddedNeoServerConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> Neo4jRule neo4jRule = <strong class="hl-keyword">new</strong> Neo4jRule(newEmbeddedNeoServerConfiguration().build());</pre></div></div><br class="example-break"><p>
						If you are only registering one embedded
						<span class="emphasis"><em>Neo4j</em></span>
						instance like previous
						<a class="link" href="#program.neo_embedded_conf" title="Example&nbsp;3.4.&nbsp;Embedded Neo4j">example</a>
						,
						calling
						<code class="function">build</code>
						is enough. If you are using more than one
						<span class="emphasis"><em>Neo4j</em></span>
						embedded connection like explained in
						<a class="link" href="#advanced.simultaneous-engine-title">Simultaneous Engine</a>
						section,
						<code class="varname">targetPath</code>
						shall be provided by using
						<code class="function">buildFromTargetPath</code>
						method.
					</p><p>
						If you are using in-memory approach mixed with embedded approach,
						target path for in-memory instance can be found at
						<code class="constant">InMemoryNeo4j.INMEMORY_NEO4J_TARGET_PATH</code>
						variable.
					</p></div><div class="section" title="Remote Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1315"></a>Remote Connection</h5></div></div></div><p>
						The second one is for configuring a connection to remote
						<span class="emphasis"><em>Neo4j</em></span>
						server (it is irrelevant at this level if it is wrapped or not).
						Default values are:
					</p><table border="1" id="d445e1323"><caption>Table&nbsp;3.6.&nbsp;Default Managed Connection Values</caption><tr>
							<td>Connection URI</td>

							<td>http://localhost:7474/db/data</td>
						</tr><tr>
							<td>Authentication</td>

							<td>No authentication parameters.</td>
						</tr></table><div class="example"><a name="program.managed_neo4j_connection_parameters"></a><p class="title"><b>Example&nbsp;3.8.&nbsp;Neo4j with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.ManagedNeoServerConfigurationBuilder.newManagedNeoServerConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> Neo4jRule neo4jRule = <strong class="hl-keyword">new</strong> Neo4jRule(newManagedNeoServerConfiguration().build());</pre></div></div><br class="example-break"></div></div><div class="section" title="Verifying Graph"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1347"></a>Verifying Graph</h4></div></div></div><p>
					<code class="classname">@ShouldMatchDataSet</code>
					is also supported for
					<span class="emphasis"><em>Neo4j</em></span>
					graphs but we should keep in mind some considerations.
				</p><p>
					To compare two graphs, stored graph is exported into
					<a class="link" href="#ex.neo4j_dataset" title="Example&nbsp;3.2.&nbsp;Example of GraphML Dataset">GraphML</a>
					format
					and then is compared with expected
					<span class="emphasis"><em>GraphML</em></span>
					using
					<span class="emphasis"><em>XmlUnit</em></span>
					framework.
					This approach implies two aspects to be considered, the
					first one
					is that although your graph does not contains any
					connection to
					reference node, reference node will
					appear too with the
					form (
					&lt;node id="0"&gt;&lt;/node&gt;
					). The other aspect is that id's are
					<span class="emphasis"><em>Neo4j's</em></span>
					internal id, so when
					you write the expected file, remember to follow
					the same id
					strategy followed by
					<span class="emphasis"><em>Neo4j</em></span>
					so id attribute of each node could be
					matched correctly with
					generated output. Inserted nodes' id starts from 1 (0 is reserved
					for reference node), meanwhile edges starts from 0.
				</p><p>
					This way to compare graphs may change in future (although this
					strategy
					will be always supported).
				</p><p>
					As I have noted in
					<a class="link" href="#verifying_database">verification section</a>
					I find that using
					<code class="classname">@ShouldMatchDataSet</code>
					is a bad approach during testing because test
					readibility is
					affected negatively. So as general guide, my advice
					is to try to
					avoid using @ShouldMatchDataSet in your tests as much as possible.
				</p></div><div class="section" title="Full Example"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1385"></a>Full Example</h4></div></div></div><p>
					To show how to use
					<span class="bold"><strong>NoSQLUnit</strong></span>
					with
					<span class="emphasis"><em>Neo4j</em></span>
					,
					we are going to create a
					very simple application that counts Neo's
					friends.
				</p><p>
					<a class="link" href="#program.matrix_neo4j_manager" title="Example&nbsp;3.9.&nbsp;Neo4j with managed configuration">MatrixManager</a>
					is the business class responsible of inserting new friends and
					counting the number of Neo's friends.
				</p><div class="example"><a name="program.matrix_neo4j_manager"></a><p class="title"><b>Example&nbsp;3.9.&nbsp;Neo4j with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> MatrixManager {

	<strong class="hl-keyword">public</strong> enum RelTypes <strong class="hl-keyword">implements</strong> RelationshipType {
		NEO_NODE, KNOWS, CODED_BY
	}

	<strong class="hl-keyword">private</strong> GraphDatabaseService graphDb;

	<strong class="hl-keyword">public</strong> MatrixManager(GraphDatabaseService graphDatabaseService) {
		<strong class="hl-keyword">this</strong>.graphDb = graphDatabaseService;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">int</strong> countNeoFriends() {

		Node neoNode = getNeoNode();
		Traverser friendsTraverser = getFriends(neoNode);

		<strong class="hl-keyword">return</strong> friendsTraverser.getAllNodes().size();

	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> addNeoFriend(String name, <strong class="hl-keyword">int</strong> age) {
		Transaction tx = <strong class="hl-keyword">this</strong>.graphDb.beginTx();
		<strong class="hl-keyword">try</strong> {
			Node friend = <strong class="hl-keyword">this</strong>.graphDb.createNode();
			friend.setProperty(<strong class="hl-string"><em style="color:red">"name"</em></strong>, name);
			Relationship relationship = getNeoNode().createRelationshipTo(friend, RelTypes.KNOWS);
			relationship.setProperty(<strong class="hl-string"><em style="color:red">"age"</em></strong>, age);
			tx.success();
		} <strong class="hl-keyword">finally</strong> {
			tx.finish();
		}
	}

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> Traverser getFriends(<strong class="hl-keyword">final</strong> Node person) {
		<strong class="hl-keyword">return</strong> person.traverse(Order.BREADTH_FIRST, StopEvaluator.END_OF_GRAPH, ReturnableEvaluator.ALL_BUT_START_NODE,
				RelTypes.KNOWS, Direction.OUTGOING);
	}

	<strong class="hl-keyword">private</strong> Node getNeoNode() {
		<strong class="hl-keyword">return</strong> graphDb.getReferenceNode().getSingleRelationship(RelTypes.NEO_NODE, Direction.OUTGOING).getEndNode();
	}

}</pre></div></div><br class="example-break"><p>
					And now one unit test and one integration test is written:
				</p><p>
					For
					<a class="link" href="#program.matrix_neo4j_unit" title="Example&nbsp;3.10.&nbsp;Neo4j with managed configuration">unit</a>
					test we are going to use embedded approach:
				</p><div class="example"><a name="program.matrix_neo4j_unit"></a><p class="title"><b>Example&nbsp;3.10.&nbsp;Neo4j with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> org.junit.Assert.assertThat;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> org.hamcrest.CoreMatchers.is;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.EmbeddedNeo4j.EmbeddedNeo4jRuleBuilder.newEmbeddedNeo4jRule;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.EmbeddedNeoServerConfigurationBuilder.newEmbeddedNeoServerConfiguration;

<strong class="hl-keyword">import</strong> javax.inject.Inject;

<strong class="hl-keyword">import</strong> org.junit.ClassRule;
<strong class="hl-keyword">import</strong> org.junit.Rule;
<strong class="hl-keyword">import</strong> org.junit.Test;
<strong class="hl-keyword">import</strong> org.neo4j.graphdb.GraphDatabaseService;

<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.UsingDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.core.LoadStrategyEnum;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.neo4j.EmbeddedNeo4j;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.neo4j.Neo4jRule;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenNeoFriendsAreRequired {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedNeo4j embeddedNeo4j = newEmbeddedNeo4jRule().build();
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> Neo4jRule neo4jRule = <strong class="hl-keyword">new</strong> Neo4jRule(newEmbeddedNeoServerConfiguration().build(), <strong class="hl-keyword">this</strong>);
	
	<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
	<strong class="hl-keyword">private</strong> GraphDatabaseService graphDatabaseService;
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="matrix.xml", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> all_direct_and_inderectly_friends_should_be_counted() {
		MatrixManager matrixManager = <strong class="hl-keyword">new</strong> MatrixManager(graphDatabaseService);
		<strong class="hl-keyword">int</strong> countNeoFriends = matrixManager.countNeoFriends();
		assertThat(countNeoFriends, is(<span class="hl-number">3</span>));
	}
	
}</pre></div></div><br class="example-break"><p>
					And as
					<a class="link" href="#program.matrix_neo4j_integration" title="Example&nbsp;3.11.&nbsp;Neo4j with managed configuration">integration test</a>
					, the managed one:
				</p><div class="example"><a name="program.matrix_neo4j_integration"></a><p class="title"><b>Example&nbsp;3.11.&nbsp;Neo4j with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.ManagedWrappingNeoServer.ManagedWrappingNeoServerRuleBuilder.newWrappingNeoServerNeo4jRule;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.ManagedNeoServerConfigurationBuilder.newManagedNeoServerConfiguration;

<strong class="hl-keyword">import</strong> javax.inject.Inject;

<strong class="hl-keyword">import</strong> org.junit.ClassRule;
<strong class="hl-keyword">import</strong> org.junit.Rule;
<strong class="hl-keyword">import</strong> org.junit.Test;
<strong class="hl-keyword">import</strong> org.neo4j.graphdb.GraphDatabaseService;

<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.ShouldMatchDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.UsingDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.core.LoadStrategyEnum;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.neo4j.ManagedWrappingNeoServer;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.neo4j.Neo4jRule;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenNeoMeetsANewFriend {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedWrappingNeoServer managedWrappingNeoServer = newWrappingNeoServerNeo4jRule().build();
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> Neo4jRule neo4jRule = <strong class="hl-keyword">new</strong> Neo4jRule(newManagedNeoServerConfiguration().build(), <strong class="hl-keyword">this</strong>);
	
	<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
	<strong class="hl-keyword">private</strong> GraphDatabaseService graphDatabaseService;
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="matrix.xml", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<em><span class="hl-annotation" style="color: gray">@ShouldMatchDataSet(location="expected-matrix.xml")</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> friend_should_be_related_into_neo_graph() {
		
		MatrixManager matrixManager = <strong class="hl-keyword">new</strong> MatrixManager(graphDatabaseService);
		matrixManager.addNeoFriend(<strong class="hl-string"><em style="color:red">"The Oracle"</em></strong>, <span class="hl-number">4</span>);
	}
	
}</pre></div></div><br class="example-break"><p>Note that in both cases we are using the same dataset as
					initial state, which looks like:
				</p><div class="example"><a name="program.expected_neo4j_file"></a><p class="title"><b>Example&nbsp;3.12.&nbsp;matrix.xml Neo4j file</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;graphml</strong> <span class="hl-attribute" style="color: #F5844C">xmlns</span>=<span class="hl-value" style="color: #993300">"http://graphml.graphdrawing.org/xmlns"</span>
         <span class="hl-attribute" style="color: #F5844C">xmlns:xsi</span>=<span class="hl-value" style="color: #993300">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hl-attribute" style="color: #F5844C">xsi:schemaLocation</span>=<span class="hl-value" style="color: #993300">"http://graphml.graphdrawing.org/xmlns
        http://graphml.graphdrawing.org/xmlns/1.0/graphml.xsd"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;key</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"name"</span> <span class="hl-attribute" style="color: #F5844C">for</span>=<span class="hl-value" style="color: #993300">"node"</span> <span class="hl-attribute" style="color: #F5844C">attr.name</span>=<span class="hl-value" style="color: #993300">"name"</span> <span class="hl-attribute" style="color: #F5844C">attr.type</span>=<span class="hl-value" style="color: #993300">"string"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;key</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"age"</span> <span class="hl-attribute" style="color: #F5844C">for</span>=<span class="hl-value" style="color: #993300">"edge"</span> <span class="hl-attribute" style="color: #F5844C">attr.name</span>=<span class="hl-value" style="color: #993300">"age"</span> <span class="hl-attribute" style="color: #F5844C">attr.type</span>=<span class="hl-value" style="color: #993300">"int"</span><strong class="hl-tag" style="color: #000096">/&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;graph</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"G"</span> <span class="hl-attribute" style="color: #F5844C">edgedefault</span>=<span class="hl-value" style="color: #993300">"directed"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"1"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"name"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>Thomas Anderson<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"2"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"name"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>Trinity<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"3"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"name"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>Morpheus<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"4"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"name"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>Agent Smith<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;node</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"5"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"name"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>The Architect<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/node&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"1"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"0"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"1"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"NEO_NODE"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"2"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"1"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"2"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"KNOWS"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"age"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>3<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"3"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"1"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"3"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"KNOWS"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"age"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>5<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"2"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"3"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"KNOWS"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"age"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>18<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"5"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"3"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"KNOWS"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"age"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>20<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;edge</strong> <span class="hl-attribute" style="color: #F5844C">id</span>=<span class="hl-value" style="color: #993300">"6"</span> <span class="hl-attribute" style="color: #F5844C">source</span>=<span class="hl-value" style="color: #993300">"4"</span> <span class="hl-attribute" style="color: #F5844C">target</span>=<span class="hl-value" style="color: #993300">"5"</span> <span class="hl-attribute" style="color: #F5844C">label</span>=<span class="hl-value" style="color: #993300">"CODED_BY"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>
            <strong class="hl-tag" style="color: #000096">&lt;data</strong> <span class="hl-attribute" style="color: #F5844C">key</span>=<span class="hl-value" style="color: #993300">"age"</span><strong class="hl-tag" style="color: #000096">&gt;</strong>20<strong class="hl-tag" style="color: #000096">&lt;/data&gt;</strong>
        <strong class="hl-tag" style="color: #000096">&lt;/edge&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;/graph&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/graphml&gt;</strong></pre></div></div><br class="example-break"></div></div></div></div><div class="chapter" title="Chapter&nbsp;4.&nbsp;Cassandra Engine"><div class="titlepage"><div><div><h2 class="title"><a name="cassandra"></a>Chapter&nbsp;4.&nbsp;Cassandra Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e1438">Cassandra</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1499">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e1515">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1553">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="Cassandra"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e1438"></a>Cassandra</h2></div></div></div><p>
			<span class="application">Cassandra</span>
			is a BigTable data model running on an Amazon Dynamo-like
			infrastructure.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>Cassandra</em></span>
			by using next classes:
		</p><p>
			</p><table border="1" id="d445e1456"><caption>Table&nbsp;4.1.&nbsp;Lifecycle Management Rules</caption><tr>
					<td>Embedded</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.cassandra.EmbeddedCassandra
						</code>
					</td>
				</tr><tr>
					<td>Managed</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.cassandra.ManagedCassandra
						</code>
					</td>
				</tr></table><p>
		</p><p>
			</p><table border="1" id="d445e1484"><caption>Table&nbsp;4.2.&nbsp;Manager Rule</caption><tr>
					<td>NoSQLUnit Management</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.cassandra.CassandraRule
						</code>
					</td>
				</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1499"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">Cassandra</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_cassandra_dep"></a><p class="title"><b>Example&nbsp;4.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-cassandra<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1515"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>Cassandra</em></span>
				module is json. To make compatible
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">
					<a class="link" href="https://github.com/jsevellec/cassandra-unit/" target="_top">Cassandra-Unit</a>
				</span>
				file format,
				<code class="classname">DataLoader</code>
				of
				<span class="application">Cassandra-Unit</span>
				project is used, so same json format file is used.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.cassandra_dataset" title="Example&nbsp;4.2.&nbsp;Example of Casssandra Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.cassandra_dataset"></a><p class="title"><b>Example&nbsp;4.2.&nbsp;Example of Casssandra Dataset</b></p><div class="example-contents"><pre class="programlisting">{
    "name" : "",
    "replicationFactor" : "",
    "strategy" : "",
    "columnFamilies" : [{
        "name" : "",
        "type" : "",
        "keyType" : "",
        "comparatorType" : "",
        "subComparatorType" : "",
        "defaultColumnValueType" : "",
        "comment" : "",
        "compactionStrategy" : "",
        "compactionStrategyOptions" : [{
            "name" : "",
            "value": ""
        }],
        "gcGraceSeconds" : "",
        "maxCompactionThreshold" : "",
        "minCompactionThreshold" : "",
        "readRepairChance" : "",
        "replicationOnWrite" : "",
        "columnsMetadata" : [{
            "name" : "",
            "validationClass : "",
            "indexType" : "",
            "indexName" : ""
        },
        ...
        ]
        "rows" : [{
            "key" : "",
            "columns" : [{
                "name" : "",
                "value" : ""
            },
            ...
            ],
            ...
            // OR
            ...
            "superColumns" : [{
                "name" : "",
                "columns" : [{
                    "name" : "",
                    "value" : ""
                },
                ...
                ]
            },
            ...
            ]
        },
        ...
        ]
    },
    ...
    ]
}</pre></div></div><br class="example-break"><p>
				See
				<a class="link" href="https://github.com/jsevellec/cassandra-unit/wiki/What-can-you-set-into-a-dataSet" target="_top">Cassandra-Unit Dataset</a>
				format for more information.
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1553"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1556"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you will require an embedded approach, managed approach or remote
					approach.
				</p><div class="section" title="Embedded Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1561"></a>Embedded Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>embedded</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.cassandra_embedded_conf" title="Example&nbsp;4.3.&nbsp;Embedded Cassandra">rule</a>
						:
					</p><div class="example"><a name="program.cassandra_embedded_conf"></a><p class="title"><b>Example&nbsp;4.3.&nbsp;Embedded Cassandra</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedCassandra embeddedCassandraRule = newEmbeddedCassandraRule().build();</pre></div></div><br class="example-break"><p>
						By default embedded
						<span class="emphasis"><em>Cassandra</em></span>
						rule uses next
						default values:
					</p><table id="d445e1582"><caption>Table&nbsp;4.3.&nbsp;Default Embedded Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>Cassandra</em></span>
								server is started and is
								<code class="constant">target/cassandra-temp</code>
								.
							</td>
						</tr><tr>
							<td>
								Cassandra Configuration File
							</td>
							<td>
								Location of yaml configuration file. By default a
								configuration
								file is provided with correct default parameters.
							</td>
						</tr><tr>
							<td>
								Host
							</td>
							<td>
								localhost
							</td>
						</tr><tr>
							<td>
								Port
							</td>
							<td>
								By default port used is 9171. Port cannot be configured, and
								cannot be changed if you provide an alternative Cassandra
								Configuration File.
							</td>
						</tr></table></div><div class="section" title="Managed Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1623"></a>Managed Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>managed</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.cassandra_managed_conf" title="Example&nbsp;4.4.&nbsp;Managed Cassandra">rule</a>
						:
					</p><div class="example"><a name="program.cassandra_managed_conf"></a><p class="title"><b>Example&nbsp;4.4.&nbsp;Managed Cassandra</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedCassandra managedCassandra = newManagedCassandraRule().build();</pre></div></div><br class="example-break"><p>
						By default managed
						<span class="emphasis"><em>Cassandra</em></span>
						rule uses next
						default values but can be configured
						programmatically:
					</p><table id="d445e1644"><caption>Table&nbsp;4.4.&nbsp;Default Managed Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>Cassandra</em></span>
								server is started and is
								<code class="constant">target/cassandra-temp</code>
								.
							</td>
						</tr><tr>
							<td>
								CassandraPath
							</td>
							<td>
								<span class="emphasis"><em>Cassandra</em></span>
								installation directory which by default is
								retrieved from
								<code class="varname">CASSANDRA_HOME</code>
								system environment
								variable.
							</td>
						</tr><tr>
							<td>
								Port
							</td>
							<td>
								By default port used is 9160. If port is changed in
								<span class="emphasis"><em>Cassandra</em></span>
								configuration file, this port should be configured too here.
							</td>
						</tr></table><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
						To start
						<span class="emphasis"><em>Cassandra</em></span><code class="varname">java.home</code>
						must be set. Normally this variable is already configured, you
						would need to do nothing.
					</div></div><div class="section" title="Remote Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1693"></a>Remote Lifecycle</h5></div></div></div><p>
						Configuring
						<span class="bold"><strong>remote</strong></span>
						approach
						does not require any special rule because you (or System
						like
						<span class="application">Maven</span>
						) is the responsible of starting and
						stopping the server. This mode
						is used in deployment tests where you
						are testing your application
						on real environment.
					</p></div></div><div class="section" title="Configuring Cassandra Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1704"></a>Configuring Cassandra Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="bold"><strong>Cassandra</strong></span>
					rule in charge of maintaining
					<span class="emphasis"><em>Cassandra</em></span>
					graph into known state by inserting and deleting defined
					datasets.
					You must register
					<code class="classname">CassandraRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule class, which
					requires a configuration parameter with
					information like host,
					port, or cluster name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects.
					Three
					different kind of configuration builders exist.
				</p><div class="section" title="Embedded Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1723"></a>Embedded Connection</h5></div></div></div><p>
						The first one is for configuring a connection to embedded
						<span class="emphasis"><em>Cassandra</em></span>
						.
					</p><div class="example"><a name="program.embedded_connection_cassandra_parameters"></a><p class="title"><b>Example&nbsp;4.5.&nbsp;Cassandra with embedded configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.EmbeddedCassandraConfigurationBuilder.newEmbeddedCassandraConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> CassandraRule cassandraRule = <strong class="hl-keyword">new</strong> CassandraRule(newEmbeddedCassandraConfiguration().clusterName(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>).build());</pre></div></div><br class="example-break"><p>
						Host and port parameters are already configured.
					</p></div><div class="section" title="Managed Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1738"></a>Managed Connection</h5></div></div></div><p>
						The first one is for configuring a connection to managed
						<span class="emphasis"><em>Cassandra</em></span>
						.
					</p><div class="example"><a name="program.managed_connection_cassandra_parameters"></a><p class="title"><b>Example&nbsp;4.6.&nbsp;Cassandra with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.ManagedCassandraConfigurationBuilder.newManagedCassandraConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> CassandraRule cassandraRule = <strong class="hl-keyword">new</strong> CassandraRule(newManagedCassandraConfiguration().clusterName(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>).build());</pre></div></div><br class="example-break"><p>
						Host and port parameters are already configured with default
						parameters of managed lifecycle. If port is changed, this class
						provides a method to set it.
					</p></div><div class="section" title="Remote Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1753"></a>Remote Connection</h5></div></div></div><p>
						Configuring a connection to remote
						<span class="emphasis"><em>Cassandra</em></span>
						.
					</p><div class="example"><a name="program.remote_connection_cassandra_parameters"></a><p class="title"><b>Example&nbsp;4.7.&nbsp;Cassandra with remote configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.RemoteCassandraConfigurationBuilder.newRemoteCassandraConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> CassandraRule cassandraRule = <strong class="hl-keyword">new</strong> CassandraRule(newRemoteCassandraConfiguration().host(<strong class="hl-string"><em style="color:red">"192.168.1.1"</em></strong>).clusterName(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>).build());</pre></div></div><br class="example-break"><p>
						Port parameter is already configured with default parameter
						of managed lifecycle. If port is changed, this class provides a
						method to set it. Note that host parameter must be specified in
						this case.
					</p></div></div><div class="section" title="Verifying Data"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1768"></a>Verifying Data</h4></div></div></div><p>
					<code class="classname">@ShouldMatchDataSet</code>
					is also supported for
					<span class="emphasis"><em>Cassandra</em></span>
					data but we should keep in mind some considerations.
				</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
					In
					<span class="bold"><strong>NoSQLUnit</strong></span>
					, expectations can only be used over data, not over configuration
					parameters, so for example fields set in
					<a class="link" href="#ex.cassandra_dataset" title="Example&nbsp;4.2.&nbsp;Example of Casssandra Dataset">dataset</a>
					file like compactionStrategy, gcGraceSeconds or
					maxCompactionThreshold are not used.
					Maybe in future will be
					supported but for now only data (keyspace, columnfamilyname,
					columns, supercolumns, ...) are supported.
				</div></div><div class="section" title="Full Example"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1787"></a>Full Example</h4></div></div></div><p>
					To show how to use
					<span class="bold"><strong>NoSQLUnit</strong></span>
					with
					<span class="emphasis"><em>Cassandra</em></span>
					,
					we are going to create a
					very simple application.
				</p><p>
					<a class="link" href="#program.person_cassandra_manager" title="Example&nbsp;4.8.&nbsp;PersonCar cassandra with manager.">PersonManager</a>
					is the business class responsible of getting and updating person's
					car.
				</p><div class="example"><a name="program.person_cassandra_manager"></a><p class="title"><b>Example&nbsp;4.8.&nbsp;PersonCar cassandra with manager.</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> PersonManager {
	
	<strong class="hl-keyword">private</strong> ColumnFamilyTemplate&lt;String, String&gt; template;
	
	<strong class="hl-keyword">public</strong> PersonManager(String clusterName, String keyspaceName, String host) {
		Cluster cluster = HFactory.getOrCreateCluster(clusterName, host);
		Keyspace keyspace = HFactory.createKeyspace(keyspaceName, cluster);
		
        template = <strong class="hl-keyword">new</strong> ThriftColumnFamilyTemplate&lt;String, String&gt;(keyspace,
        		<strong class="hl-string"><em style="color:red">"personFamilyName"</em></strong>, 
                                                               StringSerializer.get(),        
                                                               StringSerializer.get());
		
	}
	
	<strong class="hl-keyword">public</strong> String getCarByPersonName(String name) {
		ColumnFamilyResult&lt;String, String&gt; queryColumns = template.queryColumns(name);
		<strong class="hl-keyword">return</strong> queryColumns.getString(<strong class="hl-string"><em style="color:red">"car"</em></strong>);
	}
	
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> updateCarByPersonName(String name, String car) {
		ColumnFamilyUpdater&lt;String, String&gt; createUpdater = template.createUpdater(name);
		createUpdater.setString(<strong class="hl-string"><em style="color:red">"car"</em></strong>, car);
		
		template.update(createUpdater);
	}
	
}</pre></div></div><br class="example-break"><p>
					And now one unit test and one integration test is written:
				</p><p>
					For
					<a class="link" href="#program.person_cassandra_unit" title="Example&nbsp;4.9.&nbsp;Cassandra with embedded configuration">unit</a>
					test we are going to use embedded approach:
				</p><div class="example"><a name="program.person_cassandra_unit"></a><p class="title"><b>Example&nbsp;4.9.&nbsp;Cassandra with embedded configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> org.junit.Assert.assertThat;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> org.hamcrest.CoreMatchers.is;

<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.EmbeddedCassandra.EmbeddedCassandraRuleBuilder.newEmbeddedCassandraRule;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.EmbeddedCassandraConfigurationBuilder.newEmbeddedCassandraConfiguration;

<strong class="hl-keyword">import</strong> org.junit.ClassRule;
<strong class="hl-keyword">import</strong> org.junit.Rule;
<strong class="hl-keyword">import</strong> org.junit.Test;

<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.UsingDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.cassandra.CassandraRule;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.cassandra.EmbeddedCassandra;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.core.LoadStrategyEnum;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenPersonWantsToKnowItsCar {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedCassandra embeddedCassandraRule = newEmbeddedCassandraRule().build();
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> CassandraRule cassandraRule = <strong class="hl-keyword">new</strong> CassandraRule(newEmbeddedCassandraConfiguration().clusterName(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>).build());
	
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="persons.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> car_should_be_returned() {
		
		PersonManager personManager = <strong class="hl-keyword">new</strong> PersonManager(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>, <strong class="hl-string"><em style="color:red">"persons"</em></strong>, <strong class="hl-string"><em style="color:red">"localhost:9171"</em></strong>);
		String car = personManager.getCarByPersonName(<strong class="hl-string"><em style="color:red">"mary"</em></strong>);
		
		assertThat(car, is(<strong class="hl-string"><em style="color:red">"ford"</em></strong>));
		
	}
	
}</pre></div></div><br class="example-break"><p>
					And as
					<a class="link" href="#program.person_cassandra_integration" title="Example&nbsp;4.10.&nbsp;Cassandra with managed configuration">integration test</a>
					, the managed one:
				</p><div class="example"><a name="program.person_cassandra_integration"></a><p class="title"><b>Example&nbsp;4.10.&nbsp;Cassandra with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.ManagedCassandraConfigurationBuilder.newManagedCassandraConfiguration;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.ManagedCassandra.ManagedCassandraRuleBuilder.newManagedCassandraRule;

<strong class="hl-keyword">import</strong> org.junit.ClassRule;
<strong class="hl-keyword">import</strong> org.junit.Rule;
<strong class="hl-keyword">import</strong> org.junit.Test;

<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.ShouldMatchDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.UsingDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.cassandra.CassandraRule;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.cassandra.ManagedCassandra;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.core.LoadStrategyEnum;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenPersonWantsToUpdateItsCar {

	<strong class="hl-keyword">static</strong> {
		System.setProperty(<strong class="hl-string"><em style="color:red">"CASSANDRA_HOME"</em></strong>, <strong class="hl-string"><em style="color:red">"/opt/cassandra"</em></strong>);
	}
	
	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedCassandra managedCassandra = newManagedCassandraRule().build();
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> CassandraRule cassandraRule = <strong class="hl-keyword">new</strong> CassandraRule(newManagedCassandraConfiguration().clusterName(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>).build());
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="persons.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<em><span class="hl-annotation" style="color: gray">@ShouldMatchDataSet(location="expected-persons.json")</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> new_car_should_be_updated() {
		
		PersonManager personManager = <strong class="hl-keyword">new</strong> PersonManager(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>, <strong class="hl-string"><em style="color:red">"persons"</em></strong>, <strong class="hl-string"><em style="color:red">"localhost:9171"</em></strong>);
		personManager.updateCarByPersonName(<strong class="hl-string"><em style="color:red">"john"</em></strong>, <strong class="hl-string"><em style="color:red">"opel"</em></strong>);
		
	}
	
}</pre></div></div><br class="example-break"><p>Note that in both cases we are using the same dataset as
					initial state, which looks like:
				</p><div class="example"><a name="program.expected_cassandra_file"></a><p class="title"><b>Example&nbsp;4.11.&nbsp;persons.json Cassandra file</b></p><div class="example-contents"><pre class="programlisting">{
    "name" : "persons",
    "columnFamilies" : [{
        "name" : "personFamilyName",
	"keyType" : "UTF8Type",
	"defaultColumnValueType" : "UTF8Type",
	"comparatorType" : "UTF8Type",
        "rows" : [{
            "key" : "john",
            "columns" : [{
                "name" : "age",
                "value" : "22"
            },
            {
                "name" : "car",
                "value" : "toyota"
            }]
        },
        {
            "key" : "mary",
            "columns" : [{
                "name" : "age",
                "value" : "33"
            },
            {
                "name" : "car",
                "value" : "ford"
            }]
        }]
    }]
}</pre></div></div><br class="example-break"></div></div></div></div><div class="chapter" title="Chapter&nbsp;5.&nbsp;Redis Engine"><div class="titlepage"><div><div><h2 class="title"><a name="redis"></a>Chapter&nbsp;5.&nbsp;Redis Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e1840">Redis</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e1901">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e1917">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e1989">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="Redis"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e1840"></a>Redis</h2></div></div></div><p>
			<span class="application">Redis</span>
			is an open source, advanced key-value store. It is often referred to
			as a data structure server since keys can contain strings, hashes,
			lists, sets and sorted sets.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>Redis</em></span>
			by using next classes:
		</p><p>
			</p><table border="1" id="d445e1858"><caption>Table&nbsp;5.1.&nbsp;Lifecycle Management Rules</caption><tr>
					<td>Embedded</td>
					<td>
						<code class="classname">com.lordofthejars.nosqlunit.redis.EmbeddedRedis
						</code>
					</td>
				</tr><tr>
					<td>Managed</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.redis.ManagedRedis
						</code>
					</td>
				</tr></table><p>
		</p><p>
			</p><table border="1" id="d445e1886"><caption>Table&nbsp;5.2.&nbsp;Manager Rule</caption><tr>
					<td>NoSQLUnit Management</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.redis.RedisRule
						</code>
					</td>
				</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1901"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">Redis</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_redis_dep"></a><p class="title"><b>Example&nbsp;5.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-redis<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1917"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>Redis</em></span>
				module is json.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.redis_dataset" title="Example&nbsp;5.2.&nbsp;Example of Redis Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.redis_dataset"></a><p class="title"><b>Example&nbsp;5.2.&nbsp;Example of Redis Dataset</b></p><div class="example-contents"><pre class="programlisting">{
"data":[
			{"simple": [
				{
					"key":"key1", 
					"value":"value1"
				}
				]
			},
      		{"list": [{
              			"key":"key3",
              			"values":[
                  			{"value":"value3"},
                  			{"value":"value4"}
              			]
					  }]
      		},
      		
     		{"sortset": [{
                     "key":"key4",
                     "values":[
                           {"score":2, "value":"value5" },{"score":3, "value":1 }, {"score":1, "value":"value6" }]
                 }]
      		}, 
      		{"hash": [
      					{
      						"key":"user",
      						"values":[
      							{"field":"name", "value":"alex"},
      							{"field":"password", "value":"alex"}
      						]
      					}
      				]
      		},
      		{"set":[{
              			"key":"key3",
              			"values":[
                  			{"value":"value3"},
                  			{"value":"value4"}
              			]
					  }]
      		}
]
}</pre></div></div><br class="example-break"><p>
				Root element must be called
				<span class="emphasis"><em>data</em></span>
				, and then depending on kind of structured data we need to store,
				one or more of next elements should appear. Note that key field is
				used to set the key of the element, and value field is used to set a
				value.
			</p><p>
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>simple</em></span>
							:
							In case we want to store simple key/value elements. This
							element
							will contain an array of key/value entries.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>list</em></span>
							:
							In case we want to store a key with a list of values. This
							element
							contain a
							<span class="emphasis"><em>key</em></span>
							field
							for key name and
							<span class="emphasis"><em>values</em></span>
							field
							with an array of values.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>set</em></span>
							In case we want to store a key within a set (no duplicates
							allowed). Structure is the same as list element.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>sortset</em></span>
							:
							In case we want to store a key within a sorted set. This element
							contain the key, and an array of values, which each one, apart
							from value field, also contain
							<span class="emphasis"><em>score</em></span>
							field of type Number, to set the order into sorted set.
						</p></li><li class="listitem"><p>
							<span class="emphasis"><em>hash</em></span>
							:
							In case we want to store a key within a map of field/value. In
							this case
							<span class="emphasis"><em>field</em></span>
							element set the field name, and
							<span class="emphasis"><em>value</em></span>
							set the
							value of that field.
						</p></li></ul></div><p>
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d445e1989"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d445e1992"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you will require an embedded approach, managed approach or remote
					approach.
				</p><div class="section" title="Embedded Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e1997"></a>Embedded Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>embedded</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.redis_embedded_conf" title="Example&nbsp;5.3.&nbsp;Embedded Redis">rule</a>
						:
					</p><div class="example"><a name="program.redis_embedded_conf"></a><p class="title"><b>Example&nbsp;5.3.&nbsp;Embedded Redis</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedRedis embeddedRedis = newEmbeddedRedisRule().build();</pre></div></div><br class="example-break"><p>
						By default managed
						<span class="emphasis"><em>Redis</em></span>
						rule uses next
						default values but can be configured
						programmatically:
					</p><table id="d445e2018"><caption>Table&nbsp;5.3.&nbsp;Default Embedded Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>Redis</em></span>
								embedded instance is started and is
								<code class="constant">target/redis-test-data/impermanent-db</code>
								.
							</td>
						</tr></table><p>Note that target path is only used as a configuration
						parameter to allow multiple instances of embedded in-memory Redis engine.
					</p><p>For more information about embedded in-memory Redis take a tour to section: <a class="link" href="#advanced.redis_embedded.section">Embedded In-Memory Redis</a></p></div><div class="section" title="Managed Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2041"></a>Managed Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>managed</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.redis_managed_conf" title="Example&nbsp;5.4.&nbsp;Managed Redis">rule</a>
						:
					</p><div class="example"><a name="program.redis_managed_conf"></a><p class="title"><b>Example&nbsp;5.4.&nbsp;Managed Redis</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedRedis managedRedis = newManagedRedisRule().redisPath(<strong class="hl-string"><em style="color:red">"/opt/redis-2.4.16"</em></strong>).build();</pre></div></div><br class="example-break"><p>
						By default managed
						<span class="emphasis"><em>Redis</em></span>
						rule uses next
						default values but can be configured
						programmatically:
					</p><p>
						</p><table id="d445e2064"><caption>Table&nbsp;5.4.&nbsp;Default Managed Values</caption><tr>
								<td>
									Target path
								</td>
								<td>
									This is the directory where
									<span class="emphasis"><em>Redis</em></span>
									server is started and is
									<code class="constant">target/redis-temp</code>
									.
								</td>
							</tr><tr>
								<td>
									RedisPath
								</td>
								<td>
									<span class="emphasis"><em>Cassandra</em></span>
									installation directory which by default is
									retrieved from
									<code class="varname">REDIS_HOME</code>
									system environment
									variable.
								</td>
							</tr><tr>
								<td>
									Port
								</td>
								<td>
									By default port used is 6379. If port is changed in
									<span class="emphasis"><em>Redis</em></span>
									configuration file, this port should be configured too here.
								</td>
							</tr><tr>
								<td>
									Configuration File
								</td>
								<td>
									By default
									<span class="emphasis"><em>Redis</em></span>
									can work with no configuration file, it uses default values,
									but if we need to start
									<span class="emphasis"><em>Redis</em></span>
									with an specific configuration file located in any directory
									file path should be set.
								</td>
							</tr></table><p>
					</p></div><div class="section" title="Remote Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2121"></a>Remote Lifecycle</h5></div></div></div><p>
						Configuring
						<span class="bold"><strong>remote</strong></span>
						approach
						does not require any special rule because you (or System
						like
						<span class="application">Maven</span>
						) is the responsible of starting and
						stopping the server. This mode
						is used in deployment tests where you
						are testing your application
						on real environment.
					</p></div></div><div class="section" title="Configuring Redis Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2132"></a>Configuring Redis Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="bold"><strong>Redis</strong></span>
					rule in charge of maintaining
					<span class="emphasis"><em>Redis</em></span>
					store into known state by inserting and deleting defined
					datasets.
					You must register
					<code class="classname">RedisRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule class, which
					requires a configuration parameter with
					information like host,
					port, or cluster name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects.
					Three
					different kind of configuration builders exist.
				</p><div class="section" title="Embedded Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2151"></a>Embedded Connection</h5></div></div></div><p>
						The first one is for configuring an embedded connection to managed
						<span class="emphasis"><em>Redis</em></span>
						.
					</p><div class="example"><a name="program.embedded_connection_redis_parameters"></a><p class="title"><b>Example&nbsp;5.5.&nbsp;Redis with embedded configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.redis.RedisRule.RedisRuleBuilder.newRedisRule;
						
<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> RedisRule redisRule = newRedisRule().defaultEmbeddedRedis();
						</pre></div></div><br class="example-break"></div><div class="section" title="Managed Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2164"></a>Managed Connection</h5></div></div></div><p>
						Configuring a connection to managed
						<span class="emphasis"><em>Redis</em></span>
						.
					</p><div class="example"><a name="program.managed_connection_redis_parameters"></a><p class="title"><b>Example&nbsp;5.6.&nbsp;Redis with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.redis.ManagedRedisConfigurationBuilder.newManagedRedisConfiguration;
						
<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> RedisRule redisRule = <strong class="hl-keyword">new</strong> RedisRule(newManagedRedisConfiguration().build());
						</pre></div></div><br class="example-break"><p>
						Host and port parameters are already configured with default
						parameters of managed lifecycle. If port is changed, this class
						provides a method to set it.
					</p></div><div class="section" title="Remote Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2179"></a>Remote Connection</h5></div></div></div><p>
						Configuring a connection to remote
						<span class="emphasis"><em>Redis</em></span>
						.
					</p><div class="example"><a name="program.remote_connection_redis_parameters"></a><p class="title"><b>Example&nbsp;5.7.&nbsp;Redis with remote configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.redis.RemoteRedisConfigurationBuilder.newRemoteRedisConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> RedisRule redisRule = <strong class="hl-keyword">new</strong> RedisRule(newRemoteRedisConfiguration().host(<strong class="hl-string"><em style="color:red">"192.168.1.1"</em></strong>).build());</pre></div></div><br class="example-break"><p>
						Port parameter is already configured with default parameter
						of managed lifecycle. If port is changed, this class provides a
						method to set it. Note that host parameter must be specified in
						this case.
					</p></div><div class="section" title="Shard Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2194"></a>Shard Connection</h5></div></div></div><p>Redis connection can also be configured as shard using
						ShardedJedis capabilities.
					</p><div class="example"><a name="program.shard_connection_redis_parameters"></a><p class="title"><b>Example&nbsp;5.8.&nbsp;Redis with remote configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.redis.RemoteRedisConfigurationBuilder.newRemoteRedisConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> RedisRule redisRule = <strong class="hl-keyword">new</strong> RedisRule(newShardedRedisConfiguration()
				.shard(host(<strong class="hl-string"><em style="color:red">"127.0.0.1"</em></strong>), port(ManagedRedis.DEFAULT_PORT))
					.password(<strong class="hl-string"><em style="color:red">"a"</em></strong>)
					.timeout(<span class="hl-number">1000</span>)
					.weight(<span class="hl-number">1000</span>)
				.shard(host(<strong class="hl-string"><em style="color:red">"127.0.0.1"</em></strong>), port(ManagedRedis.DEFAULT_PORT + <span class="hl-number">1</span>))
					.password(<strong class="hl-string"><em style="color:red">"b"</em></strong>)
					.timeout(<span class="hl-number">3000</span>)
					.weight(<span class="hl-number">3000</span>)
				.build());</pre></div></div><br class="example-break"><p>
						Note that only
						<span style="color: red">&lt;methodparam&gt;host&lt;/methodparam&gt;</span>
						and
						<span style="color: red">&lt;methodparam&gt;port&lt;/methodparam&gt;</span>
						is mandatory, the other ones uses default values.
					</p><p>
						</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
									<span class="emphasis"><em>password</em></span>
									:
									In case repository is protected with password this attribute
									is used as password. Default values is null.
								</p></li><li class="listitem"><p>
									<span class="emphasis"><em>timeout</em></span>
									:
									Timeout for shard. By default timeout is set to 2 seconds.
								</p></li><li class="listitem"><p>
									<span class="emphasis"><em>weight</em></span>
									:
									The weight of that shard over the other ones. By default is 1.
								</p></li></ul></div><p>
					</p></div></div><div class="section" title="Verifying Data"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2234"></a>Verifying Data</h4></div></div></div><p>
					<code class="classname">@ShouldMatchDataSet</code>
					is also supported for
					<span class="emphasis"><em>Redis</em></span>
					engine.
				</p></div><div class="section" title="Full Example"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2245"></a>Full Example</h4></div></div></div><p>
					To show how to use
					<span class="bold"><strong>NoSQLUnit</strong></span>
					with
					<span class="emphasis"><em>Redis</em></span>
					,
					we are going to create a
					very simple application.
				</p><p>
					<a class="link" href="#program.book_redis_manager" title="Example&nbsp;5.9.&nbsp;Book manager with Redis">BookManager</a>
					is the business class responsible of inserting new books and
					finding books by their title.
				</p><div class="example"><a name="program.book_redis_manager"></a><p class="title"><b>Example&nbsp;5.9.&nbsp;Book manager with Redis</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> BookManager {
	
	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> String TITLE_FIELD_NAME = <strong class="hl-string"><em style="color:red">"title"</em></strong>;
	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">static</strong> <strong class="hl-keyword">final</strong> String NUMBER_OF_PAGES = <strong class="hl-string"><em style="color:red">"numberOfPages"</em></strong>;
	
	<strong class="hl-keyword">private</strong> Jedis jedis;
	
	<strong class="hl-keyword">public</strong> BookManager(Jedis jedis) {
		<strong class="hl-keyword">this</strong>.jedis = jedis;
	}
	
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> insertBook(Book book) {
		
		Map&lt;String, String&gt; fields = <strong class="hl-keyword">new</strong> HashMap&lt;String, String&gt;();
		
		fields.put(TITLE_FIELD_NAME, book.getTitle());
		fields.put(NUMBER_OF_PAGES, Integer.toString(book.getNumberOfPages()));
		
		jedis.hmset(book.getTitle(), fields);
	}

	<strong class="hl-keyword">public</strong> Book findBookByTitle(String title) {
		
		Map&lt;String, String&gt; fields = jedis.hgetAll(title);
		<strong class="hl-keyword">return</strong> <strong class="hl-keyword">new</strong> Book(fields.get(TITLE_FIELD_NAME), Integer.parseInt(fields.get(NUMBER_OF_PAGES)));
		
	}
	
}</pre></div></div><br class="example-break"><p>
					And now one integration test is written:
				</p><div class="example"><a name="program.book_redis_integration"></a><p class="title"><b>Example&nbsp;5.10.&nbsp;Redis with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.redis.RedisRule.RedisRuleBuilder.newRedisRule;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.redis.ManagedRedis.ManagedRedisRuleBuilder.newManagedRedisRule;

<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> org.junit.Assert.assertThat;
<strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> org.hamcrest.CoreMatchers.is;

<strong class="hl-keyword">import</strong> org.junit.ClassRule;
<strong class="hl-keyword">import</strong> org.junit.Rule;
<strong class="hl-keyword">import</strong> org.junit.Test;

<strong class="hl-keyword">import</strong> redis.clients.jedis.Jedis;

<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.annotation.UsingDataSet;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.core.LoadStrategyEnum;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.demo.model.Book;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.redis.ManagedRedis;
<strong class="hl-keyword">import</strong> com.lordofthejars.nosqlunit.redis.RedisRule;

<strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenYouFindABook {

	<strong class="hl-keyword">static</strong> {
		System.setProperty(<strong class="hl-string"><em style="color:red">"REDIS_HOME"</em></strong>, <strong class="hl-string"><em style="color:red">"/opt/redis-2.4.16"</em></strong>);
	}

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedRedis managedRedis = newManagedRedisRule().build();

	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> RedisRule redisRule = newRedisRule().defaultManagedRedis();
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="book.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> book_should_be_returned_if_title_is_in_database() {
		
		BookManager bookManager = <strong class="hl-keyword">new</strong> BookManager(<strong class="hl-keyword">new</strong> Jedis(<strong class="hl-string"><em style="color:red">"localhost"</em></strong>));
		Book findBook = bookManager.findBookByTitle(<strong class="hl-string"><em style="color:red">"The Hobbit"</em></strong>);
		
		assertThat(findBook, is(<strong class="hl-keyword">new</strong> Book(<strong class="hl-string"><em style="color:red">"The Hobbit"</em></strong>, <span class="hl-number">293</span>)));
		
	}

}</pre></div></div><br class="example-break"><p>And dataset used is:
				</p><div class="example"><a name="program.expected_redis_file"></a><p class="title"><b>Example&nbsp;5.11.&nbsp;book.json Redis file</b></p><div class="example-contents"><pre class="programlisting">{
"data":[	
      		{"hash": [
      					{
      						"key":"The Hobbit",
      						"values":[
      							{"field":"title", "value":"The Hobbit"},
      							{"field":"numberOfPages", "value":"293"}
      						]
      					}
      				]
      		}
]
}</pre></div></div><br class="example-break"></div></div></div></div><div class="chapter" title="Chapter&nbsp;6.&nbsp;HBase Engine"><div class="titlepage"><div><div><h2 class="title"><a name="hbase"></a>Chapter&nbsp;6.&nbsp;HBase Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e2283">HBase</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2344">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e2360">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e2384">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="HBase"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e2283"></a>HBase</h2></div></div></div><p>
			<span class="application">Apache HBase </span>
			is an open-source, distributed, versioned, column-oriented store.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>HBase</em></span>
			by using next classes:
		</p><p>
			</p><table border="1" id="d445e2301"><caption>Table&nbsp;6.1.&nbsp;Lifecycle Management Rules</caption><tr>
					<td>Embedded</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.hbase.EmbeddedHBase
						</code>
					</td>
				</tr><tr>
					<td>Managed</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.hbase.ManagedHBase
						</code>
					</td>
				</tr></table><p>
		</p><p>
			</p><table border="1" id="d445e2329"><caption>Table&nbsp;6.2.&nbsp;Manager Rule</caption><tr>
					<td>NoSQLUnit Management</td>

					<td>
						<code class="classname">com.lordofthejars.nosqlunit.hbase.HBaseRule
						</code>
					</td>
				</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d445e2344"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">HBase</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.nosqlunit_hbase_dep"></a><p class="title"><b>Example&nbsp;6.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-hbase<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d445e2360"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>HBase</em></span>
				module is json. Dataset in HBase is the same used by
				<span class="application">
					<a class="link" href="https://github.com/jsevellec/cassandra-unit/" target="_top">Cassandra-Unit</a>
				</span>
				but not all fields are supported. Only fields available in TSV HBase
				application can be set into dataset.
			</p><p>
				So as summary datasets must have next
				<a class="link" href="#ex.hbase_dataset" title="Example&nbsp;6.2.&nbsp;Example of HBase Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.hbase_dataset"></a><p class="title"><b>Example&nbsp;6.2.&nbsp;Example of HBase Dataset</b></p><div class="example-contents"><pre class="programlisting">{
    "name" : "tablename",
    "columnFamilies" : [{
        "name" : "columnFamilyName",
        "rows" : [{
            "key" : "key1",
            "columns" : [{
                "name" : "columnName",
                "value" : "columnValue"
            },
            ...
            ]
        },
        ...
        ]
    },
    ...
    ]
}</pre></div></div><br class="example-break"></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d445e2384"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2387"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you will require an embedded approach, managed approach or remote
					approach.
				</p><div class="section" title="Embedded Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2392"></a>Embedded Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>embedded</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.hbase_embedded_conf" title="Example&nbsp;6.3.&nbsp;Embedded HBase">rule</a>
						:
					</p><div class="example"><a name="program.hbase_embedded_conf"></a><p class="title"><b>Example&nbsp;6.3.&nbsp;Embedded HBase</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedHBase embeddedHBase = newEmbeddedHBaseRule().build();</pre></div></div><br class="example-break"><p>
						By default embedded
						<span class="emphasis"><em>Embedded</em></span>
						rule uses
						<code class="classname">HBaseTestingUtility</code>
						default values:
					</p><table id="d445e2416"><caption>Table&nbsp;6.3.&nbsp;Default Embedded Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>HBase</em></span>
								stores data and is
								<code class="constant">target/data</code>
								.
							</td>
						</tr><tr>
							<td>
								Host
							</td>
							<td>
								localhost
							</td>
						</tr><tr>
							<td>
								Port
							</td>
							<td>
								By default port used is 60000.
							</td>
						</tr><tr>
							<td>File Permissions</td>
							<td>
								Depending on your umask configuration,
								<code class="classname">HBaseTestingUtility</code>
								will create some directories that will not be accessible during
								runtime. By default this value is set to 775, but depending on
								your OS you may require a different value.
							</td>
						</tr></table></div><div class="section" title="Managed Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2460"></a>Managed Lifecycle</h5></div></div></div><p>
						To configure
						<span class="bold"><strong>managed</strong></span>
						approach you should only instantiate next
						<a class="link" href="#program.hbase_managed_conf" title="Example&nbsp;6.4.&nbsp;Managed HBase">rule</a>
						:
					</p><div class="example"><a name="program.hbase_managed_conf"></a><p class="title"><b>Example&nbsp;6.4.&nbsp;Managed HBase</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedHBase managedHBase = newManagedHBaseServerRule().build();</pre></div></div><br class="example-break"><p>
						By default managed
						<span class="emphasis"><em>HBase</em></span>
						rule uses next
						default values but can be configured
						programmatically:
					</p><table id="d445e2481"><caption>Table&nbsp;6.4.&nbsp;Default Managed Values</caption><tr>
							<td>
								Target path
							</td>
							<td>
								This is the directory where
								<span class="emphasis"><em>HBase</em></span>
								server is started and is
								<code class="constant">target/hbase-temp</code>
								.
							</td>
						</tr><tr>
							<td>
								CassandraPath
							</td>
							<td>
								<span class="emphasis"><em>HBase</em></span>
								installation directory which by default is
								retrieved from
								<code class="varname">HBASE_HOME</code>
								system environment
								variable.
							</td>
						</tr><tr>
							<td>
								Port
							</td>
							<td>
								By default port used is 60000. If port is changed in
								<span class="emphasis"><em>HBase</em></span>
								configuration file, this port should be configured too here.
							</td>
						</tr></table><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
						To start
						<span class="emphasis"><em>HBASE</em></span><code class="varname">JAVA_HOME</code>
						must be set. Normally this variable is already configured, so you
						would need to do nothing.
					</div></div><div class="section" title="Remote Lifecycle"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2530"></a>Remote Lifecycle</h5></div></div></div><p>
						Configuring
						<span class="bold"><strong>remote</strong></span>
						approach
						does not require any special rule because you (or System
						like
						<span class="application">Maven</span>
						) is the responsible of starting and
						stopping the server. This mode
						is used in deployment tests where you
						are testing your application
						on real environment.
					</p></div></div><div class="section" title="Configuring HBase Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2541"></a>Configuring HBase Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="bold"><strong>HBase</strong></span>
					rule in charge of maintaining
					<span class="emphasis"><em>HBase</em></span>
					columns into known state by inserting and deleting defined
					datasets.
					You must register
					<code class="classname">HBaseRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule class, which
					requires a configuration parameter with
					some
					information.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects.
					Three
					different kind of configuration builders exist.
				</p><div class="section" title="Embedded Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2560"></a>Embedded Connection</h5></div></div></div><p>
						The first one is for configuring a connection to embedded
						<span class="emphasis"><em>HBase</em></span>
						.
					</p><div class="example"><a name="program.embedded_connection_hbase_parameters"></a><p class="title"><b>Example&nbsp;6.5.&nbsp;HBase with embedded configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.hbase.EmbeddedHBase.EmbeddedHBaseRuleBuilder.newEmbeddedHBaseRule;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> HBaseRule hBaseRule = newHBaseRule().defaultEmbeddedHBase();</pre></div></div><br class="example-break"><p>
						Embedded HBase does not require any special parameter.
						Configuration object is copied from Embedded rule directly to
						HBaseRule.
					</p></div><div class="section" title="Managed Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2575"></a>Managed Connection</h5></div></div></div><p>
						This is for configuring a connection to managed
						<span class="emphasis"><em>HBase</em></span>
						.
					</p><div class="example"><a name="program.managed_connection_hbase_parameters"></a><p class="title"><b>Example&nbsp;6.6.&nbsp;HBase with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.hbase.ManagedHBaseConfigurationBuilder.newManagedHBaseConfiguration;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> HBaseRule hbaseRule = <strong class="hl-keyword">new</strong> HBaseRule(newManagedHBaseConfiguration().build());</pre></div></div><br class="example-break"><p>
						By default configuration used is the one loaded by calling
						HBaseConfiguration.create() method.
						<a class="link" href="http://hbase.apache.org/apidocs/org/apache/hadoop/hbase/HBaseConfiguration.html#create()" target="_top">HBaseConfiguration.create()</a>
						which uses hbase-site.xml and hbase-default.xml classpath files.
					</p><p>
						But also a method
						<code class="function">setProperty</code>
						method is provided to modify any parameter of generated
						configuration object.
					</p></div><div class="section" title="Remote Connection"><div class="titlepage"><div><div><h5 class="title"><a name="d445e2598"></a>Remote Connection</h5></div></div></div><p>
						Configuring a connection to remote
						<span class="emphasis"><em>HBase</em></span>
						uses same approach like ManagedHBase configuration object but
						using
						<code class="classname">com.lordofthejars.nosqlunit.hbase.RemoteHBaseConfigurationBuilder
						</code>
						class instead of
						com.lordofthejars.nosqlunit.hbase.ManagedHBaseConfigurationBuilder.
						.
					</p></div><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
						Working with Apache HBase required a bit of knowledge about
						how it works. For example your /etc/hosts file cannot contain a
						reference to your host name with ip 127.0.1.1.
					</p><p>
						Moreover
						<span class="bold"><strong>NoSQLUnit</strong></span>
						uses
						<span class="emphasis"><em>HBase-0.94.1</em></span>
						and this version should be also installed in your computer to work
						with managed or remote approach. If you install another version, you should
						exclude these artifacts from
						<span class="bold"><strong>NoSQLUnit</strong></span>
						dependencies, and add the new ones manually to your pom file.
					</p></div></div><div class="section" title="Verifying Data"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2623"></a>Verifying Data</h4></div></div></div><p>
					<code class="classname">@ShouldMatchDataSet</code>
					is also supported for
					<span class="emphasis"><em>HBase</em></span>
					data but we should keep in mind some considerations.
				</p><p>
					If you plan to verify data with
					<code class="classname">@ShouldMatchDataSet</code>
					in Managed and Remote approach, you should enable Aggregate
					coprocessor by editing hbase-site-xml file and adding next lines:
				</p><div class="example"><a name="program.coprocessor_hbase_parameters"></a><p class="title"><b>Example&nbsp;6.7.&nbsp;HBase with coprocessor</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;property&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;name&gt;</strong>hbase.coprocessor.user.region.classes<strong class="hl-tag" style="color: #000096">&lt;/name&gt;</strong>
    <strong class="hl-tag" style="color: #000096">&lt;value&gt;</strong>org.apache.hadoop.hbase.coprocessor.AggregateImplementation<strong class="hl-tag" style="color: #000096">&lt;/value&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/property&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Full Example"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2644"></a>Full Example</h4></div></div></div><p>
					To show how to use
					<span class="bold"><strong>NoSQLUnit</strong></span>
					with
					<span class="emphasis"><em>HBase</em></span>
					,
					we are going to create a
					very simple application.
				</p><p>
					<a class="link" href="#program.person_hbase_manager" title="Example&nbsp;6.8.&nbsp;PersonCar cassandra with manager.">PersonManager</a>
					is the business class responsible of getting and updating person's
					car.
				</p><div class="example"><a name="program.person_hbase_manager"></a><p class="title"><b>Example&nbsp;6.8.&nbsp;PersonCar cassandra with manager.</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> PersonManager {

	<strong class="hl-keyword">private</strong> Configuration configuration;
	
	<strong class="hl-keyword">public</strong> PersonManager(Configuration configuration) {
		<strong class="hl-keyword">this</strong>.configuration = configuration;		
	}
	
	<strong class="hl-keyword">public</strong> String getCarByPersonName(String personName) <strong class="hl-keyword">throws</strong> IOException {
		HTable table = <strong class="hl-keyword">new</strong> HTable(configuration, <strong class="hl-string"><em style="color:red">"person"</em></strong>);
		Get get = <strong class="hl-keyword">new</strong> Get(<strong class="hl-string"><em style="color:red">"john"</em></strong>.getBytes());
		Result result = table.get(get);
		
		<strong class="hl-keyword">return</strong> <strong class="hl-keyword">new</strong> String(result.getValue(toByteArray().convert(<strong class="hl-string"><em style="color:red">"personFamilyName"</em></strong>), toByteArray().convert(<strong class="hl-string"><em style="color:red">"car"</em></strong>)));
	}
	
	<strong class="hl-keyword">private</strong> Converter&lt;String, <strong class="hl-keyword">byte</strong>[]&gt; toByteArray() {
		<strong class="hl-keyword">return</strong> <strong class="hl-keyword">new</strong> Converter&lt;String, <strong class="hl-keyword">byte</strong>[]&gt;() {

			<em><span class="hl-annotation" style="color: gray">@Override</span></em>
			<strong class="hl-keyword">public</strong> <strong class="hl-keyword">byte</strong>[] convert(String element) {
				<strong class="hl-keyword">return</strong> element.getBytes();
			}
		};
	}
	
}</pre></div></div><br class="example-break"><p>
					And now one unit test is written:
				</p><p>
					For
					<a class="link" href="#program.person_hbase_unit" title="Example&nbsp;6.9.&nbsp;HBase with embedded configuration">unit</a>
					test we are going to use embedded approach:
				</p><div class="example"><a name="program.person_hbase_unit"></a><p class="title"><b>Example&nbsp;6.9.&nbsp;HBase with embedded configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenPersonWantsToKnowItsCar {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> EmbeddedHBase embeddedHBase = newEmbeddedHBaseRule().build();
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> HBaseRule hBaseRule = newHBaseRule().defaultEmbeddedHBase(<strong class="hl-keyword">this</strong>);
	
	<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
	<strong class="hl-keyword">private</strong> Configuration configuration;
	
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="persons.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> car_should_be_returned() <strong class="hl-keyword">throws</strong> IOException {

		PersonManager personManager = <strong class="hl-keyword">new</strong> PersonManager(configuration);
		String car = personManager.getCarByPersonName(<strong class="hl-string"><em style="color:red">"john"</em></strong>);
		
		assertThat(car, is(<strong class="hl-string"><em style="color:red">"toyota"</em></strong>));		
	}
	
}</pre></div></div><br class="example-break"><p>And dataset used is:
				</p><div class="example"><a name="program.expected_hbase_file"></a><p class="title"><b>Example&nbsp;6.10.&nbsp;persons.json HBase file</b></p><div class="example-contents"><pre class="programlisting">{
    "name" : "person",
    "columnFamilies" : [{
        "name" : "personFamilyName",
        "rows" : [{
            "key" : "john",
            "columns" : [{
                "name" : "age",
                "value" : "22"
            },
            {
                "name" : "car",
                "value" : "toyota"
            }]
        },
        {
            "key" : "mary",
            "columns" : [{
                "name" : "age",
                "value" : "33"
            },
            {
                "name" : "car",
                "value" : "ford"
            }]
        }]
    }]
}</pre></div></div><br class="example-break"></div></div></div></div><div class="chapter" title="Chapter&nbsp;7.&nbsp;CouchDB Engine"><div class="titlepage"><div><div><h2 class="title"><a name="couchdb"></a>Chapter&nbsp;7.&nbsp;CouchDB Engine</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e2687">CouchDB</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2743">Maven Setup</a></span></dt><dt><span class="section"><a href="#d445e2759">Dataset Format</a></span></dt><dt><span class="section"><a href="#d445e2782">Getting Started</a></span></dt></dl></dd></dl></div><div class="section" title="CouchDB"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e2687"></a>CouchDB</h2></div></div></div><p>
			<span class="application">CouchDB</span>
			is a
			<span class="emphasis"><em>NoSQL</em></span>
			database that stores structured data as
			<span class="emphasis"><em>JSON-like</em></span>
			documents with dynamic schemas.
		</p><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports
			<span class="emphasis"><em>CouchDB</em></span>
			by using next classes:
		</p><p>
		</p><table border="1" id="d445e2711"><caption>Table&nbsp;7.1.&nbsp;Lifecycle Management Rules</caption><tr>
				<td>Managed</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.couchdb.ManagedCouchDb
					</code>
				</td>
			</tr></table><p>
		</p><p>
		</p><table border="1" id="d445e2728"><caption>Table&nbsp;7.2.&nbsp;Manager Rule</caption><tr>
				<td>NoSQLUnit Management</td>

				<td>
					<code class="classname">com.lordofthejars.nosqlunit.couchdb.CouchDbRule
					</code>
				</td>
			</tr></table><p>
		</p><div class="section" title="Maven Setup"><div class="titlepage"><div><div><h3 class="title"><a name="d445e2743"></a>Maven Setup</h3></div></div></div><p>
				To use
				<span class="bold"><strong>NoSQLUnit</strong></span>
				with
				<span class="application">CouchDB</span>
				you only need to add next
				dependency:
			</p><div class="example"><a name="conf.couchdb_nosqlunit_dep"></a><p class="title"><b>Example&nbsp;7.1.&nbsp;NoSqlUnit Maven Repository</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-tag" style="color: #000096">&lt;dependency&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;groupId&gt;</strong>com.lordofthejars<strong class="hl-tag" style="color: #000096">&lt;/groupId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;artifactId&gt;</strong>nosqlunit-couchdb<strong class="hl-tag" style="color: #000096">&lt;/artifactId&gt;</strong>
	<strong class="hl-tag" style="color: #000096">&lt;version&gt;</strong>${version.nosqlunit}<strong class="hl-tag" style="color: #000096">&lt;/version&gt;</strong>
<strong class="hl-tag" style="color: #000096">&lt;/dependency&gt;</strong></pre></div></div><br class="example-break"></div><div class="section" title="Dataset Format"><div class="titlepage"><div><div><h3 class="title"><a name="d445e2759"></a>Dataset Format</h3></div></div></div><p>
				Default dataset file format in
				<span class="emphasis"><em>CouchDB</em></span>
				module
				is
				<span class="emphasis"><em>json</em></span>
				.
			</p><p>
				Datasets must have next
				<a class="link" href="#ex.couchdb_dataset" title="Example&nbsp;7.2.&nbsp;Example of CouchDB Dataset">
					format
				</a>
				:
			</p><div class="example"><a name="ex.couchdb_dataset"></a><p class="title"><b>Example&nbsp;7.2.&nbsp;Example of CouchDB Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"data":
			[
				{"attribute1":"value1", "atribute2":"value2", ...},
				{...}
			]
}</pre></div></div><br class="example-break"><p>Notice that if attributes value are integers, double quotes are
				not required.
			</p></div><div class="section" title="Getting Started"><div class="titlepage"><div><div><h3 class="title"><a name="d445e2782"></a>Getting Started</h3></div></div></div><div class="section" title="Lifecycle Management Strategy"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2785"></a>Lifecycle Management Strategy</h4></div></div></div><p>
					First step is defining which lifecycle management strategy is
					required for your tests. Depending on kind of test you are
					implementing (unit test, integration test, deployment test, ...)
					you
					will require an
					<span class="bold"><strong>managed</strong></span>
					approach or
					<span class="bold"><strong>remote</strong></span>
					approach.
				</p><p>
				There is no <span class="emphasis"><em>CouchDB</em></span> inmemory instance, so only managed or remote lifecycle can be used.
				</p><p>
					To configure the
					<span class="bold"><strong>managed</strong></span>
					way,
					you should use
					<code class="classname">ManagedCouchDb</code>
					rule and may
					require some <a class="link" href="#program.couchdb_managed_conf" title="Example&nbsp;7.3.&nbsp;Managed CouchDB">configuration</a> parameters.
				</p><div class="example"><a name="program.couchdb_managed_conf"></a><p class="title"><b>Example&nbsp;7.3.&nbsp;Managed CouchDB</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.couchdb.ManagedCouchDb.ManagedCouchDbRuleBuilder.newManagedCouchDbRule;

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedCouchDb managedCouchDb = newManagedCouchDbRule().couchDbPath(<strong class="hl-string"><em style="color:red">"/usr/local"</em></strong>).build(); </pre></div></div><br class="example-break"><p>
					By default managed
					<span class="emphasis"><em>CouchDB</em></span>
					rule uses next
					default values:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
							<span class="emphasis"><em>CouchDB</em></span>
							installation directory is
							retrieved from
							<code class="varname">COUCHDB_HOME</code>
							system environment
							variable.
						</p></li><li class="listitem"><p>
							Target path, that is the directory where
							<span class="emphasis"><em>CouchDB</em></span>
							server is started, is
							<code class="constant">target/couchdb-temp</code>
							.
						</p></li><li class="listitem"><p>
							Port where <span class="emphasis"><em>CouchDB</em></span> will be started. Note that this parameter is used only as information, if you change port from configuration file you should change this parameter too.
							By default<span class="emphasis"><em>CouchDB</em></span>
							server is started at
							<code class="constant">5984</code>
							.
						</p></li></ul></div><p>
					Configuring
					<span class="bold"><strong>remote</strong></span>
					approach
					does not require any special rule because you (or System like
					<span class="application">Maven</span>
					) is the responsible of starting and
					stopping the server. This mode is used in deployment tests where you
					are testing your application on real environment.
				</p></div><div class="section" title="Configuring CouchDB Connection"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2861"></a>Configuring CouchDB Connection</h4></div></div></div><p>
					Next step is configuring
					<span class="emphasis"><em>
						<span class="bold"><strong>CouchDB</strong></span>
					</em></span>
					rule in charge of
					maintaining
					<span class="emphasis"><em>CouchDB</em></span>
					database into known state by
					inserting and deleting defined datasets. You must register
					<code class="classname">CouchDbRule</code>
					<span class="emphasis"><em>JUnit</em></span>
					rule
					class, which requires a configuration parameter with information like
					host, port or database name.
				</p><p>To make developer's life easier and code more readable, a
					fluent
					interface can be used to create these configuration objects.
				</p><table border="1" id="d445e2883"><caption>Table&nbsp;7.3.&nbsp;Default Managed Configuration Values</caption><tr>
						<td>URI</td>

						<td>http://localhost5984</td>
					</tr><tr>
						<td>Authentication</td>

						<td>No authentication parameters.</td>
					</tr><tr>
						<td>Enable SSL</td>

						<td>false.</td>
					</tr><tr>
						<td>Relaxed SSL Settings</td>

						<td>false.</td>
					</tr><tr>
						<td>Caching</td>

						<td>True.</td>
					</tr></table><div class="example"><a name="program.couchdb_managed_connection_parameters"></a><p class="title"><b>Example&nbsp;7.4.&nbsp;CouchDBRule with managed configuration</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.couchdb.CouchDbRule.CouchDbRuleBuilder.newCouchDbRule;

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> CouchDbRule couchDbRule = newCouchDbRule().defaultManagedMongoDb(<strong class="hl-string"><em style="color:red">"books"</em></strong>);</pre></div></div><br class="example-break"></div><div class="section" title="Complete Example"><div class="titlepage"><div><div><h4 class="title"><a name="d445e2931"></a>Complete Example</h4></div></div></div><p>
					Consider a library application, which apart from multiple
					operations, it allow us to add new books to system. Our
					<a class="link" href="#example.couchdb_book_model" title="Example&nbsp;7.5.&nbsp;Book POJO">model</a>
					is as simple as:
				</p><div class="example"><a name="example.couchdb_book_model"></a><p class="title"><b>Example&nbsp;7.5.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> Book {

	<strong class="hl-keyword">private</strong> String title;

	<strong class="hl-keyword">private</strong> <strong class="hl-keyword">int</strong> numberOfPages;

	<strong class="hl-keyword">public</strong> Book(String title, <strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">super</strong>();
		<strong class="hl-keyword">this</strong>.title = title;
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setTitle(String title) {
		<strong class="hl-keyword">this</strong>.title = title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> setNumberOfPages(<strong class="hl-keyword">int</strong> numberOfPages) {
		<strong class="hl-keyword">this</strong>.numberOfPages = numberOfPages;
	}


	<strong class="hl-keyword">public</strong> String getTitle() {
		<strong class="hl-keyword">return</strong> title;
	}

	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">int</strong> getNumberOfPages() {
		<strong class="hl-keyword">return</strong> numberOfPages;
	}
}</pre></div></div><br class="example-break"><p>
					Next business
					<a class="link" href="#example.couchdb_book_manager" title="Example&nbsp;7.6.&nbsp;Book POJO">class</a>
					is the responsible of managing access to
					<span class="emphasis"><em>CouchDB</em></span>
					server:
				</p><div class="example"><a name="example.couchdb_book_manager"></a><p class="title"><b>Example&nbsp;7.6.&nbsp;Book POJO</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">private</strong> CouchDbConnector connector;
	
	<strong class="hl-keyword">public</strong> BookManager(CouchDbConnector connector)  {
		<strong class="hl-keyword">this</strong>.connector = connector;
	}
	
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> create(Book book) {
		connector.create(MapBookConverter.toMap(book));
	}

	<strong class="hl-keyword">public</strong> Book findBookById(String id) {
		Map&lt;String, Object&gt; map = connector.get(Map.<strong class="hl-keyword">class</strong>, id);
		<strong class="hl-keyword">return</strong> MapBookConverter.toBook(map);
	}</pre></div></div><br class="example-break"><p>
					And now it is time for testing. In next
					<a class="link" href="#example.couchdb_test_find_book" title="Example&nbsp;7.7.&nbsp;Test with Managed Connection">test</a>
					we are going to
					validate that a book is found into database.
				</p><div class="example"><a name="example.couchdb_test_find_book"></a><p class="title"><b>Example&nbsp;7.7.&nbsp;Test with Managed Connection</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">public</strong> <strong class="hl-keyword">class</strong> WhenYouFindBooksById {

	<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedCouchDb managedCouchDb = newManagedCouchDbRule().couchDbPath(<strong class="hl-string"><em style="color:red">"/usr/local"</em></strong>).build(); 
	
	<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
	<strong class="hl-keyword">public</strong> CouchDbRule couchDbRule = newCouchDbRule().defaultManagedMongoDb(<strong class="hl-string"><em style="color:red">"books"</em></strong>);
	
	<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
	<strong class="hl-keyword">private</strong> CouchDbConnector couchDbConnector;
	
	<em><span class="hl-annotation" style="color: gray">@Test</span></em>
	<em><span class="hl-annotation" style="color: gray">@UsingDataSet(locations="books.json", loadStrategy=LoadStrategyEnum.CLEAN_INSERT)</span></em>
	<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> identified_book_should_be_returned() {
		
		BookManager bookManager = <strong class="hl-keyword">new</strong> BookManager(couchDbConnector);
		Book book = bookManager.findBookById(<strong class="hl-string"><em style="color:red">"1"</em></strong>);
		
		assertThat(book.getTitle(), is(<strong class="hl-string"><em style="color:red">"The Hobbit"</em></strong>));
		assertThat(book.getNumberOfPages(), is(<span class="hl-number">293</span>));
		
	}
	
}</pre></div></div><br class="example-break"><div class="example"><a name="example.couchdb_dataset_book"></a><p class="title"><b>Example&nbsp;7.8.&nbsp;Initial Dataset</b></p><div class="example-contents"><pre class="programlisting">{
	"data":
			[
				{"_id":"1", "title":"The Hobbit","numberOfPages":"293"}
			]
}</pre></div></div><br class="example-break"><p>
					You can watch full example at
					<a class="link" href="https://github.com/lordofthejars/nosql-unit/tree/master/nosqlunit-demo" target="_top">github</a>
					.
				</p></div></div></div></div></div><div class="part" title="Part&nbsp;III.&nbsp;Advanced Usage"><div class="titlepage"><div><div><h1 class="title"><a name="advanced-usage-part"></a>Part&nbsp;III.&nbsp;Advanced Usage</h1></div></div></div><div class="partintro" title="Advanced Usage"><div></div><p>
				This chapter provides some examples of advanced features of <span class="bold"><strong>NoSQLUnit</strong></span> not described in previous chapters.
			</p><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#advanced">8. Advanced Usage</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e2989">Embedded In-Memory Redis</a></span></dt><dt><span class="section"><a href="#d445e3107">Managing lifecycle of multiple instances</a></span></dt><dt><span class="section"><a href="#d445e3125">Fast Way</a></span></dt><dt><span class="section"><a href="#d445e3169">Simultaneous engines</a></span></dt><dt><span class="section"><a href="#d445e3261">Support for JSR-330</a></span></dt></dl></dd></dl></div></div><div class="chapter" title="Chapter&nbsp;8.&nbsp;Advanced Usage"><div class="titlepage"><div><div><h2 class="title"><a name="advanced"></a>Chapter&nbsp;8.&nbsp;Advanced Usage</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e2989">Embedded In-Memory Redis</a></span></dt><dt><span class="section"><a href="#d445e3107">Managing lifecycle of multiple instances</a></span></dt><dt><span class="section"><a href="#d445e3125">Fast Way</a></span></dt><dt><span class="section"><a href="#d445e3169">Simultaneous engines</a></span></dt><dt><span class="section"><a href="#d445e3261">Support for JSR-330</a></span></dt></dl></div><div class="section" title="Embedded In-Memory Redis"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e2989"></a>Embedded In-Memory Redis</h2></div></div></div><p>
			When you are writing unit tests you should keep in mind that they
			must run fast, which implies, among other
			things, no interaction with
			IO subsystem (disk, network, ...). To
			avoid this interaction in
			database unit tests, there are embedded
			in-memory databases like
			<span class="emphasis"><em>H2</em></span>
			,
			<span class="emphasis"><em>HSQLDB</em></span>
			,
			<span class="emphasis"><em>Derby</em></span>
			or in case of
			<span class="emphasis"><em>NoSQL</em></span>
			, engines like
			<span class="emphasis"><em>Neo4j</em></span>
			or
			<span class="emphasis"><em>Cassandra</em></span>
			have their own implementation. But
			<span class="emphasis"><em>Redis</em></span>
			does not have any way to create an embedded in-memory instance in
			Java. For this reason I have written an embedded in-memory
			<span class="emphasis"><em>Redis</em></span>
			implementation based on
			<span class="emphasis"><em>Jedis</em></span>
			project.
		</p><p>
			If you are using
			<span class="bold"><strong>NoSQLUnit</strong></span>
			you only have to register embedded
			<span class="emphasis"><em>Redis</em></span>
			rule as described
			<a class="link" href="#program.redis_embedded_conf" title="Example&nbsp;5.3.&nbsp;Embedded Redis">here</a>
			, and internally
			<span class="bold"><strong>NoSQLUnit</strong></span>
			will create instance for you, and you
			will be able to
			<a class="link" href="#advanced.jsr330-title">inject</a>
			the instance into your code.
		</p><p>
			But also can be used outside umbrella of
			<span class="bold"><strong>NoSQLUnit</strong></span>
			, by instantiating manually, as described in next
			<a class="link" href="#advanced.instantiate-embedded-redis" title="Example&nbsp;8.1.&nbsp;Embedded In-Memory Redis.">example:</a>
		</p><div class="example"><a name="advanced.instantiate-embedded-redis"></a><p class="title"><b>Example&nbsp;8.1.&nbsp;Embedded In-Memory Redis.</b></p><div class="example-contents"><pre class="programlisting">EmbeddedRedisBuilder embeddedRedisBuilder = <strong class="hl-keyword">new</strong> EmbeddedRedisBuilder();
Jedis jedis = embeddedRedisBuilder.createEmbeddedJedis();	
			</pre></div></div><br class="example-break"><p>Notice that Jedis class is the main class defined by Jedis
			project but proxied to use in-memory data instead of sending requests
			to remote server.
		</p><p>
			Almost all
			<span class="emphasis"><em>Redis</em></span>
			operations have been implemented but it has some limitations:
		</p><p>
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
						Connection commands do nothing, they do not throw any
						exception but neither do any action. In fact would not have
						sense
						that they do something.
					</p></li><li class="listitem"><p>
						Scripting commands are not supported, and an
						<code class="classname">UnsupportedOperationException</code>
						will be thrown if they are called.
					</p></li><li class="listitem"><p>
						Transaction commands are not supported, but they do not throw
						any exception, simply returns a null value
						and in cases of List
						return type, an empty list is returned.
					</p></li><li class="listitem"><p>
						Pub/Sub commands do nothing.
					</p></li><li class="listitem"><p>
						Server commands are implemented, but there are some commands
						that have no sense and returns a constant result:
					</p><p>
						<span class="emphasis"><em>move</em></span>
						always return 1.
					</p><p>
						<span class="emphasis"><em>debug</em></span>
						commands throws an UnsupportedOperationException.
					</p><p>
						<span class="emphasis"><em>bgrewriteaof, save, bgsave, configSet, configResetStat,
							salveOf, slaveOfNone and slowLogReset
						</em></span>
						returns an OK.
					</p><p>
						<span class="emphasis"><em>configGet, slowLogGet and slowLogGetBinary</em></span>
						returns an empty list.
					</p></li><li class="listitem"><p>
						From Key commands, only sort by pattern is not supported.
					</p></li></ul></div><p>
		</p><p>
			All the other operations, including flushing, expiration
			control, and each operation of every datatype is supported in the
			same way Jedis support it. Note that expiration management is also
			implemented as described in Redis manual.
		</p><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>
			This implementation of Redis is provided for testing purposes
			not as a substitution of Redis. Feel free to notify any issue of this
			implementation so can be fixed or implemented.
		</div></div><div class="section" title="Managing lifecycle of multiple instances"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e3107"></a>Managing lifecycle of multiple instances</h2></div></div></div><p>
			Sometimes your test will require that more than one instance of
			same
			database server (running in different ports) was started. For
			example
			for testing database sharding. In
			<a class="link" href="#advanced.multipleinstances-database" title="Example&nbsp;8.2.&nbsp;Multiple Instances of Redis.">next example</a>
			we see how to
			configure
			<span class="bold"><strong>NoSQLUnit</strong></span>
			to manage lifecycle of multiple instances.
		</p><div class="example"><a name="advanced.multipleinstances-database"></a><p class="title"><b>Example&nbsp;8.2.&nbsp;Multiple Instances of Redis.</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedRedis managedRedis7<span class="hl-number">9</span> = newManagedRedisRule().redisPath(<strong class="hl-string"><em style="color:red">"/opt/redis-2.4.16"</em></strong>)
								.targetPath(<strong class="hl-string"><em style="color:red">"target/redis1"</em></strong>)
								.configurationPath(getAbsoluteFilePath(<strong class="hl-string"><em style="color:red">"src/test/resources/redis_6379.conf"</em></strong>))
								.port(<span class="hl-number">6379</span>)
								.build();

<em><span class="hl-annotation" style="color: gray">@ClassRule</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">static</strong> ManagedRedis managedRedis8<span class="hl-number">0</span> = newManagedRedisRule().redisPath(<strong class="hl-string"><em style="color:red">"/opt/redis-2.4.16"</em></strong>)
								.targetPath(<strong class="hl-string"><em style="color:red">"target/redis2"</em></strong>)
								.configurationPath(getAbsoluteFilePath(<strong class="hl-string"><em style="color:red">"src/test/resources/redis_6380.conf"</em></strong>))
								.port(<span class="hl-number">6380</span>)
								.build();
			</pre></div></div><br class="example-break"><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3>Note that target path should be set to different values for
			each instance, if not some started processes could not be shutdown.
		</div></div><div class="section" title="Fast Way"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e3125"></a>Fast Way</h2></div></div></div><p>
			When you instantiate a Rule for maintaining database into known state
			(
			<code class="classname">MongoDbRule</code>
			,
			<code class="classname">Neo4jRule</code>
			, ...)
			<span class="bold"><strong>NoSQLUnit</strong></span>
			requires you set a configuration object with properties like host,
			port, database name, ... but although most of the time default values
			are enough, we still need to create the configuration object, which
			means our code becomes harder to read.
		</p><p>
			We can avoid this by using an inner builder inside each rule,
			which
			creates for us a Rule with default parameters set. For example for
			<code class="classname">Neo4jRule</code>
			:
		</p><div class="example"><a name="advanced.fastway-database"></a><p class="title"><b>Example&nbsp;8.3.&nbsp;Embedded Neo4jRule with defaults.</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.neo4j.Neo4jRule.Neo4jRuleBuilder.newNeo4jRule;
<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> Neo4jRule neo4jRule = newNeo4jRule().defaultEmbeddedNeo4j();</pre></div></div><br class="example-break"><p>
			In previous
			<a class="link" href="#advanced.fastway-database" title="Example&nbsp;8.3.&nbsp;Embedded Neo4jRule with defaults.">example</a>
			<code class="classname">Neo4jRule</code>
			is configured to be used as embedded approach with default
			parameters.
		</p><p>
			Another example using
			<code class="classname">CassandraRule</code>
			in managed way.
		</p><div class="example"><a name="advanced.fastway-managed-database"></a><p class="title"><b>Example&nbsp;8.4.&nbsp;Managed Cassandra with defaults.</b></p><div class="example-contents"><pre class="programlisting"><strong class="hl-keyword">import</strong> <strong class="hl-keyword">static</strong> com.lordofthejars.nosqlunit.cassandra.CassandraRule.CassandraRuleBuilder.newCassandraRule;
<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> CassandraRule cassandraRule = newCassandraRule().defaultManagedCassandra(<strong class="hl-string"><em style="color:red">"Test Cluster"</em></strong>);</pre></div></div><br class="example-break"><p>And each Rule contains their builder class to create default
			values.
		</p></div><div class="section" title="Simultaneous engines"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e3169"></a>Simultaneous engines</h2></div></div></div><p>
			Sometimes applications will contain more than one
			<span class="emphasis"><em>NoSQL</em></span>
			engine,
			for example some parts of your model will be expressed better
			as a
			graph (
			<span class="application">Neo4J</span>
			for example), but other parts will be more natural in a
			column way
			(for example using
			<span class="application">Cassandra</span>
			).
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports this
			kind of scenarios by providing in integration tests a
			way to not load
			all datasets into one system, but choosing which
			datasets are stored
			in each backend.
		</p><p>
			For declaring more than one engine, you must give a name to each
			database
			<span class="emphasis"><em>Rule</em></span>
			using
			<code class="function">connectionIdentifier()</code>
			method in configuration instance.
		</p><div class="example"><a name="advanced.name-database"></a><p class="title"><b>Example&nbsp;8.5.&nbsp;Given a name database rule</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule1 = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb()
                                        .databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).connectionIdentifier(<strong class="hl-string"><em style="color:red">"one"</em></strong>).build() ,<strong class="hl-keyword">this</strong>);</pre></div></div><br class="example-break"><p>
			And also you need to provide an identified dataset for each engine,
			by using
			<code class="function">withSelectiveLocations</code>
			attribute of
			<code class="function">@UsingDataSet</code>
			annotation. You must set up the pair "named connection" / datasets.
		</p><div class="example"><a name="advanced.dataset-selective"></a><p class="title"><b>Example&nbsp;8.6.&nbsp;Selective dataset example</b></p><div class="example-contents"><pre class="programlisting">@UsingDataSet(withSelectiveLocations =												 
				{ <em><span class="hl-annotation" style="color: gray">@Selective(identifier = "one", locations = "test3")</span></em> }, 
			loadStrategy = LoadStrategyEnum.REFRESH)</pre></div></div><br class="example-break"><p>
			In
			<a class="link" href="#advanced.dataset-selective" title="Example&nbsp;8.6.&nbsp;Selective dataset example">example</a>
			we are refreshing database declared on
			<a class="link" href="#advanced.name-database" title="Example&nbsp;8.5.&nbsp;Given a name database rule">previous example</a>
			with data located at
			<span class="emphasis"><em>test3</em></span>
			file.
		</p><p>
			Also works in expectations annotation:
		</p><div class="example"><a name="advanced.expected-dataset-selective"></a><p class="title"><b>Example&nbsp;8.7.&nbsp;Selective expectation example</b></p><div class="example-contents"><pre class="programlisting">@ShouldMatchDataSet(withSelectiveMatcher = 
				{ <em><span class="hl-annotation" style="color: gray">@SelectiveMatcher(identifier = "one", location = "test3")</span></em> 
				})</pre></div></div><br class="example-break"><p>
			When you use more than one engine at a time you should take
			under
			consideration next rules:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
				If location attribute is set, it will use it and will ignore
				<code class="function">withSelectiveMatcher</code>
				attribute data. Location data is populated through all registered
				systems.
			</li><li class="listitem">
				If location is not set, then system tries to insert data defined in
				<code class="function">withSelectiveMatcher</code>
				attribute to each backend.
			</li><li class="listitem">
				If
				<code class="function">withSelectiveMatcher</code>
				attribute is not set, then default strategy (explained in
				<a class="link" href="#seeding_database">section</a>
				) is taken. Note that default strategy will replicate all datasets
				to defined engines.
			</li></ul></div><p>
			You can also use the same approach for inserting data into same
			engine but in different databases. If you have one
			<span class="application">MongoDb</span>
			instance with two databases, you can also write tests for both
			databases at one time. For example:
		</p><div class="example"><a name="advanced.multiple-mongodb"></a><p class="title"><b>Example&nbsp;8.8.&nbsp;Multiple connections example</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule1 = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb()
					.databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).connectionIdentifier(<strong class="hl-string"><em style="color:red">"one"</em></strong>).build() ,<strong class="hl-keyword">this</strong>);

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule2 = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb()
					.databaseName(<strong class="hl-string"><em style="color:red">"test2"</em></strong>).connectionIdentifier(<strong class="hl-string"><em style="color:red">"two"</em></strong>).build() ,<strong class="hl-keyword">this</strong>);

<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<em><span class="hl-annotation" style="color: gray">@UsingDataSet(withSelectiveLocations = {
		@Selective(identifier = "one", locations = "json.test"),
		@Selective(identifier = "two", locations = "json3.test") }, 
	loadStrategy = LoadStrategyEnum.CLEAN_INSERT)</span></em>
<strong class="hl-keyword">public</strong> <strong class="hl-keyword">void</strong> my_test() {...}
</pre></div></div><br class="example-break"></div><div class="section" title="Support for JSR-330"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e3261"></a>Support for JSR-330</h2></div></div></div><p>
			<span class="bold"><strong>NoSQLUnit</strong></span>
			supports two annotations of
			<acronym class="acronym">JSR-330</acronym>
			aka Dependency Injection for Java. Concretely
			<code class="classname">@Inject</code>
			and
			<code class="classname">@Named</code>
			annotations.
		</p><p>
			During test execution you may need to access underlying class used to
			load and assert data to execute extra operations to backend.
			<span class="bold"><strong>NoSQLUnit</strong></span>
			will inspect
			<code class="classname">@Inject</code>
			annotations of test fields, and try to set own driver to attribute.
			For example in case of
			<span class="application">MongoDb</span>
			,
			<code class="classname">com.mongodb.Mongo</code>
			instance will be injected.
		</p><div class="example"><a name="advanced.injection"></a><p class="title"><b>Example&nbsp;8.9.&nbsp;Injection example</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule1 = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb()
						.databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).build() ,<strong class="hl-keyword">this</strong>);

<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
<strong class="hl-keyword">private</strong> Mongo mongo;</pre></div></div><br class="example-break"><div class="warning" title="Warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>
				Note that in
				<a class="link" href="#advanced.injection" title="Example&nbsp;8.9.&nbsp;Injection example">example</a>
				we are setting
				<code class="varname">this</code>
				as second parameter to the Rule. This is only required in versions
				of JUnit prior to 4.11. In new versions is no longer required
				passing the this parameter.
			</p></div><p>
			But if you are using more than one engine at same time (see
			<a class="link" href="#advanced.simultaneous-engine-title">chapter</a>
			) you need a way to distinguish each connection. For fixing this
			problem, you must use
			<code class="classname">@Named</code>
			annotation by putting the identifier given in configuration instance.
			For example:
		</p><div class="example"><a name="advanced.named-injection"></a><p class="title"><b>Example&nbsp;8.10.&nbsp;Named injection example</b></p><div class="example-contents"><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule1 = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb()
					.databaseName(<strong class="hl-string"><em style="color:red">"test"</em></strong>).connectionIdentifier(<strong class="hl-string"><em style="color:red">"one"</em></strong>).build() ,<strong class="hl-keyword">this</strong>);

<em><span class="hl-annotation" style="color: gray">@Rule</span></em>
<strong class="hl-keyword">public</strong> MongoDbRule remoteMongoDbRule2 = <strong class="hl-keyword">new</strong> MongoDbRule(mongoDb()
					.databaseName(<strong class="hl-string"><em style="color:red">"test2"</em></strong>).connectionIdentifier(<strong class="hl-string"><em style="color:red">"two"</em></strong>).build() ,<strong class="hl-keyword">this</strong>);

<em><span class="hl-annotation" style="color: gray">@Named("one")</span></em>
<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
<strong class="hl-keyword">private</strong> Mongo mongo1;
	
<em><span class="hl-annotation" style="color: gray">@Named("two")</span></em>
<em><span class="hl-annotation" style="color: gray">@Inject</span></em>
<strong class="hl-keyword">private</strong> Mongo mongo2;</pre></div></div><br class="example-break"></div></div></div><div class="part" title="Part&nbsp;IV.&nbsp;Stay In Touch"><div class="titlepage"><div><div><h1 class="title"><a name="stay-in-touch-part"></a>Part&nbsp;IV.&nbsp;Stay In Touch</h1></div></div></div><div class="partintro" title="Stay In Touch"><div></div><p>
				This chapter provides information about next releases and how to stay in touch with the project.
			</p><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="chapter"><a href="#touch">9. Stay In Touch</a></span></dt><dd><dl><dt><span class="section"><a href="#d445e3328">Future releases</a></span></dt><dt><span class="section"><a href="#d445e3344">Stay in Touch</a></span></dt></dl></dd></dl></div></div><div class="chapter" title="Chapter&nbsp;9.&nbsp;Stay In Touch"><div class="titlepage"><div><div><h2 class="title"><a name="touch"></a>Chapter&nbsp;9.&nbsp;Stay In Touch</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#d445e3328">Future releases</a></span></dt><dt><span class="section"><a href="#d445e3344">Stay in Touch</a></span></dt></dl></div><div class="section" title="Future releases"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e3328"></a>Future releases</h2></div></div></div><p>
			Version 0.4.0 will have support for
			<span class="emphasis"><em>Neo4J and
				Cassandra.
			</em></span>
		</p><p>
			Next versions will contain support for
			<span class="emphasis"><em>HBase</em></span>
			and
			<span class="emphasis"><em>CouchDb</em></span>
			.
		</p></div><div class="section" title="Stay in Touch"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="d445e3344"></a>Stay in Touch</h2></div></div></div><table id="d445e3347"><tr>
				<td>Email: </td>
				<td>asotobu at gmail.com</td>
			</tr><tr>
				<td>Blog: </td>
				<td><a class="link" href="www.lordofthejars.com" target="_top">Lord Of The Jars</a></td>
			</tr><tr>
				<td>Twitter: </td>
				<td>@alexsotob</td>
			</tr><tr>
				<td>Github: </td>
				<td><a class="link" href="https://github.com/lordofthejars/nosql-unit/" target="_top">NoSQLUnit Github</a></td>
			</tr></table></div></div></div></div></body></html>